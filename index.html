<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>Mochi Note V9.8 Perfect Fit</title>

<link rel="icon" href="icon.jpeg">
<link rel="apple-touch-icon" href="icon.jpeg">

<meta name="apple-mobile-web-app-title" content="Puzzles">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Allura&family=Dancing+Script&family=Ephesis&family=Great+Vibes&family=Monsieur+La+Doulaise&family=Noto+Serif+SC:wght@300&family=Pacifico&family=Parisienne&family=Petit+Formal+Script&family=Pinyon+Script&family=Qwigley&family=Sacramento&family=Tangerine&family=UnifrakturMaguntia&display=swap" rel="stylesheet">

<style>

  /* ================= 1. åŸºç¡€å˜é‡ ================= */
  :root {
    --primary: #E69A8D;        
    --bg-body: #F9F3F3;        
    --bg-top:  #FCEEEE;        
    --bubble-R: #FBE3E1;       
    
    --text-main: #5A5A5A;      
    --text-bubble-r: #5A5A5A; 

    --card-bg: #FFFFFF;
    --shadow: 0 8px 30px rgba(0,0,0,0.06);

    --header-font: 'Pinyon Script', cursive; 
  }

  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%; 
    overflow: hidden; 
    background-color: var(--bg-body);
    font-family: -apple-system, "PingFang SC", sans-serif; 
    color: var(--text-main);
    -webkit-user-select: none; user-select: none;
  }

  #app-container {
    width: 100%; max-width: 500px;
    height: 100dvh; 
    margin: 0 auto; 
    background-color: var(--card-bg);
    display: flex; flex-direction: column;
    box-shadow: var(--shadow);
    position: relative;
  }

  [contenteditable="true"], input { -webkit-user-select: text; user-select: text; }

  /* ================= 2. é¡¶éƒ¨åŒºåŸŸ ================= */
  .top-area {
    background-color: var(--bg-top);
    transition: background-color 0.5s;
    border-bottom: 1px solid rgba(0,0,0,0.03);
    padding-bottom: 12px;
    flex-shrink: 0; 
    z-index: 100;
    padding-top: env(safe-area-inset-top); 
  }

  header {
    padding: 15px 20px 10px 20px;
    display: flex; justify-content: space-between; align-items: center; 
  }

  h1 {
    font-size: 20px; font-weight: 700; margin: 0;
    color: var(--primary); letter-spacing: 0.5px; transition: color 0.5s;
  }

  .sub-header {
    padding: 0 20px 5px 20px;
    position: relative; 
    display: flex; align-items: center;
  }

  .control-row {
    display: flex; align-items: center; gap: 8px;
    width: 100%;
  }

  /* å¼€å…³ç»„ */
  .switch-group {
      display: flex; align-items: center; gap: 6px;
  }
  .switch-wrap {
    display: flex; align-items: center; gap: 4px;
    font-size: 11px; color: #999;
    background: rgba(255,255,255,0.6);
    padding: 2px 6px 2px 4px;
    border-radius: 15px;
    white-space: nowrap;
    flex-shrink: 0;
  }
   
  .switch-input { display: none; }
  .switch-label {
    width: 22px; height: 13px;
    background: #ccc; border-radius: 10px;
    position: relative; cursor: pointer; transition: 0.3s;
  }
  .switch-label::after {
    content: ''; position: absolute; top: 1.5px; left: 2px;
    width: 10px; height: 10px; background: #fff;
    border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  .switch-input:checked + .switch-label { background: var(--primary); }
  .switch-input:checked + .switch-label::after { transform: translateX(9px); }

  .header-input {
    background: transparent; border: none; outline: none;
    font-size: 13px; color: #aaa;
    flex: 1; 
    border-bottom: 1px dashed transparent;
    transition: all 0.3s;
    font-family: -apple-system, "PingFang SC", sans-serif; 
    padding-bottom: 2px;
    margin-left: 5px;
  }
  .header-input:focus, .header-input:not(:placeholder-shown) {
    border-bottom-color: var(--primary); color: var(--text-main);
  }
  .header-input::placeholder { color: #dcb; font-style: italic; opacity: 0.7; }

  .font-btn {
    width: 28px; height: 28px;
    background: rgba(255,255,255,0.6);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-family: serif; font-style: italic; font-weight: bold;
    color: #888; cursor: pointer;
    font-size: 14px;
    flex-shrink: 0;
  }
  .font-btn:active, .font-btn.active { background: #fff; color: var(--primary); }

  #font-dropdown {
    position: absolute;
    top: 50px; right: 20px; 
    width: 200px; 
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.12);
    z-index: 200;
    max-height: 240px; 
    overflow-y: auto;
    display: none;
    padding: 8px;
    border: 1px solid rgba(0,0,0,0.04);
  }
  #font-dropdown::-webkit-scrollbar { width: 0 !important; }

  .font-item {
    padding: 10px 12px;
    font-size: 16px;
    cursor: pointer;
    color: #666;
    border-radius: 8px;
    margin-bottom: 2px;
    display: flex; justify-content: space-between; align-items: center;
    transition: all 0.2s;
  }
  .font-item:hover { background: #FCEEEE; color: var(--primary); padding-left: 16px;}
  .font-item.selected { background: var(--bg-top); color: var(--primary); font-weight: bold; }
  .font-item.selected::after { content: 'â—'; font-size: 8px; color: var(--primary); }

  .toggle-box {
    background: rgba(255,255,255,0.5); border-radius: 20px; padding: 3px;
    display: flex; font-size: 13px; cursor: pointer; flex-shrink: 0;
  }
  .toggle-item {
    padding: 6px 14px; border-radius: 18px; color: #999; transition: all 0.3s;
  }
  .toggle-item.active {
    background: #fff; color: var(--primary); font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  /* ================= 3. å·¥å…·æ  ================= */
  .toolbar {
    padding: 0 20px; display: flex; flex-direction: column; gap: 12px;
    margin-top: 10px;
  }
  .row-func { display: flex; align-items: stretch; gap: 10px; height: 72px; }
   
  /* æ»‘å—ç»„ */
  .slider-group {
      flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 8px;
      background: rgba(255,255,255,0.4);
      padding: 0 15px; border-radius: 16px;
  }
  .slider-row {
      display: flex; align-items: center; gap: 8px;
      font-size: 12px; color: #999;
  }
  input[type=range] {
    -webkit-appearance: none; flex: 1; height: 4px; background: #ddd; border-radius: 2px;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 14px; height: 14px;
    background: #fff; border: 2px solid var(--primary);
    border-radius: 50%; cursor: pointer; transition: transform 0.1s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  input[type=range]::-webkit-slider-thumb:active { transform: scale(1.2); background: var(--primary); }

  /* æŒ‰é’®çŸ©é˜µ */
  .btn-grid {
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      grid-template-rows: 1fr 1fr; 
      gap: 6px;
      width: 72px; 
  }
  .icon-btn {
    width: 100%; height: 100%; border-radius: 8px; border: none;
    background: rgba(255,255,255,0.6); color: #777; font-size: 14px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    padding: 0;
  }
  .icon-btn:active { transform: scale(0.95); background: #fff; }
  .icon-btn svg { width: 14px; height: 14px; stroke: #777; stroke-width: 2.5; }
   
  .icon-btn.btn-active { background: #fff; color: var(--primary); border: 1px solid var(--primary); }

  .row-colors { display: flex; align-items: center; justify-content: space-between; }
   
  .marker-palette {
    display: flex; align-items: center; gap: 6px;
    background: rgba(255,255,255,0.4);
    padding: 4px 6px; border-radius: 20px;
  }
  .marker-icon { font-size: 14px; margin-right: 0; color:#888;} 
   
  .color-dot {
    width: 14px; height: 14px;
    border-radius: 50%; cursor: pointer;
    border: 2px solid rgba(0,0,0,0.05); transition: transform 0.2s;
  }
  .color-dot:active { transform: scale(0.8); }
  .color-dot.clear { background: #fff; border: 2px solid #ccc; position: relative; }
  .color-dot.clear::after {
    content:''; position: absolute; top: 50%; left: 50%; width: 8px; height: 2px;
    background: #ccc; transform: translate(-50%, -50%) rotate(45deg);
  }

  /* é«˜äº®æ ·å¼ç±» */
  .hl-pink   { background-color: rgba(255, 216, 228, 0.8); }
  .hl-green  { background-color: rgba(208, 240, 192, 0.8); }
  .hl-purple { background-color: rgba(242, 227, 248, 0.8); }
  .hl-blue   { background-color: rgba(204, 242, 255, 0.8); }
  .hl-yellow { background-color: rgba(255, 250, 205, 0.8); }
  .hl-gray   { background-color: rgba(232, 232, 232, 0.8); }

  .theme-palette { display: flex; gap: 6px; }
  .theme-dot {
    width: 14px; height: 14px; border-radius: 50%; border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer;
  }

  /* ================= 4. å†…å®¹åŒº & å®æ—¶é¢„è§ˆ ================= */
  .viewport {
    flex: 1; 
    overflow-y: auto; 
    padding: 25px;
    font-size: 16px; scroll-behavior: smooth; background: #fff; 
    padding-bottom: 20vh; 
  }

  /* --- æŠ¬å¤´åŒºåŸŸ --- */
  #paper-header {
    width: 100%;
    margin-bottom: 25px; 
    color: var(--primary);
    transition: color 0.5s;
    display: none; 
    font-family: var(--header-font); 
    
    flex-direction: row;
    align-items: stretch; /* é«˜åº¦æ‹‰ä¼¸ */
    justify-content: flex-start; 
    gap: 15px; 
  }
   
  /* å›¾ç‰‡å®¹å™¨ (åŒ…è£¹å›¾ç‰‡+é½¿è½®+é¢æ¿) */
  #header-img-wrap {
      position: relative;
      display: none; /* é»˜è®¤éšè—ï¼Œç”± updateHeaderPreview æ§åˆ¶ */
      flex-shrink: 0;
      margin-right: 10px;
  }
  
  /* æŠ¬å¤´å›¾ç‰‡æ¡† */
  #header-img-preview {
      width: 0; min-width: 0;
      border-radius: 6px;
      background-size: cover; background-position: center;
      background-repeat: no-repeat;
      cursor: pointer;
      border: 1.5px dashed #e0e0e0;
      transition: opacity 0.2s, background-image 0.3s;
  }
  body.printing #header-img-preview { border: none !important; }

  /* âš™ï¸ å›¾ç‰‡é½¿è½®æŒ‰é’® */
  #btn-img-gear {
      position: absolute;
      top: 0; right: -28px; /* ç§»åˆ°çº¿æ¡†å³ä¾§å¤– */
      width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      cursor: pointer;
      opacity: 0.3;
      transition: opacity 0.3s, transform 0.5s;
      z-index: 60;
  }
  #btn-img-gear:hover { opacity: 1; transform: rotate(90deg); }
  body.printing #btn-img-gear { display: none !important; }

  /* âš™ï¸ å›¾ç‰‡æ§åˆ¶é¢æ¿ */
  #img-toolbar {
      position: absolute;
      top: 30px; left: 0;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 10px;
      width: 170px; /* åŠ å®½é˜²æ­¢æº¢å‡º */
      display: none; /* ç‚¹å‡»é½¿è½®æ˜¾ç¤º */
      z-index: 200;
      flex-direction: column; gap: 10px;
  }
  body.printing #img-toolbar { display: none !important; }

  .img-row {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      font-size: 11px; color: #888;
  }
  .img-row.presets { justify-content: space-around; margin-top: 4px; }
  
  /* é¢„è®¾å›¾åºŠå›¾æ ‡ */
  .preset-img {
      width: 32px; height: 32px; border-radius: 6px;
      background-size: 80%; background-position: center; background-repeat:no-repeat;
      cursor: pointer; border: 1px solid #eee; background-color: #fff;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .preset-img:active { transform: scale(0.9); border-color: var(--primary); }
  .preset-img:hover { background-color: #fafafa; }
  
  /* å›¾ç‰‡é¢œè‰²æ§åˆ¶ */
  .img-color-row { display: flex; justify-content: space-evenly; width: 100%; margin-top: 5px; }
  .img-color-dot {
      width: 16px; height: 16px; border-radius: 50%; cursor: pointer;
      border: 2px solid rgba(0,0,0,0.05);
  }
  .img-color-dot:active { transform: scale(0.8); }
  
  /* å›¾ç‰‡é€æ˜åº¦æ»‘å— */
  .img-slider {
      -webkit-appearance: none; height: 4px; background: #eee; border-radius: 2px; flex: 1;
      width: 100%; /* ç¡®ä¿å¡«æ»¡ */
  }
  .img-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 10px; height: 10px;
      background: #888; border-radius: 50%; cursor: pointer;
  }


/* æ–‡å­—åˆ— */
  .header-text-col {
      display: flex; flex-direction: column; align-items: flex-end;
      justify-content: center; /* ä¿®æ”¹ï¼šç”± space-between æ”¹ä¸º centerï¼Œç´§å‡‘æ’åˆ— */
      margin-left: auto; /* å¼ºåˆ¶é å³ */
      flex-shrink: 0;
      min-height: 1.5em; 
      
      /* --- å…³é”®ä¿®å¤ä»£ç  --- */
      height: fit-content; /* å¼ºåˆ¶é«˜åº¦åªåŒ…è£¹æ–‡å­—å†…å®¹ï¼Œä¸æ¥å—æ‹‰ä¼¸ */
      align-self: center;  /* è‡ªèº«å‚ç›´å±…ä¸­ï¼Œæ‰“æ–­çˆ¶çº§ stretch å±æ€§çš„å½±å“ */
  }

  .preview-note {
    font-weight: 400; opacity: 1; display: block; line-height: 1.2;
    text-align: right; white-space: nowrap;
  }
   
  .preview-date {
    font-weight: 400; opacity: 1; display: block; margin-top: 4px;
    font-family: inherit; color: inherit; text-align: right; white-space: nowrap;   
  }

  /* --- æ ‡é¢˜åŒºåŸŸå®¹å™¨ --- */
  #title-container {
      position: relative;
      width: 100%;
      margin-bottom: 10px;
      display: none; /* æ•´ä½“æ˜¾éš */
  }

  /* æ ‡é¢˜æ¨¡å¼æ¡† */
  #title-box-wrap {
      width: 100%;
      box-sizing: border-box;
      border: 1.5px dashed #ddd; 
      border-radius: 8px;
      padding: 10px 30px 10px 10px; /* å³ä¾§ç•™ç©ºç»™é½¿è½® */
      text-align: center;
      font-weight: bold;
      color: var(--text-main);
      outline: none;
      transition: all 0.3s;
  }
  #title-box-wrap:empty:before {
      content: 'ç‚¹å‡»è¾“å…¥æ ‡é¢˜';
      color: #ccc; font-weight: normal; font-size: 0.6em;
  }
  body.printing #title-box-wrap { border: none !important; padding: 10px 0; }

  /* âš™ï¸ æ ‡é¢˜é½¿è½®æŒ‰é’® */
  #btn-title-gear {
      position: absolute;
      top: 5px; right: 5px;
      width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      cursor: pointer;
      opacity: 0.4;
      transition: opacity 0.3s, transform 0.5s;
      z-index: 10;
  }
  #btn-title-gear:hover { opacity: 1; transform: rotate(90deg); }
  body.printing #btn-title-gear { display: none !important; }

  /* ================= 6. æ ‡é¢˜ä¸“å±å·¥å…·æ¡ ================= */
  #title-toolbar {
      display: none; /* é»˜è®¤éšè—ï¼Œç‚¹å‡»é½¿è½®æ˜¾ç¤º */
      margin-top: 5px;
      margin-bottom: 20px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border-radius: 12px;
      padding: 10px;
      flex-direction: column;
      width: 100%;
      box-sizing: border-box;
      position: relative;
      z-index: 50;
      animation: slideDown 0.3s ease-out;
  }
  @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
  
  body.printing #title-toolbar,
  body.printing #title-font-menu {
      display: none !important;
  }

  .tt-row {
      display: flex; align-items: center; gap: 8px; justify-content: center;
      width: 100%;
  }

  /* æŒ‰é’®æ ·å¼ */
  .tt-btn {
      width: 28px; height: 28px; border-radius: 6px;
      background: #f2f2f2; color: #666;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: bold; cursor: pointer;
      font-family: serif;
      transition: all 0.2s;
  }
  .tt-btn.active { background: var(--primary); color: #fff; }
  
  .font-family-btn { width: auto; padding: 0 8px; font-family: sans-serif; font-size: 11px; gap: 4px; }
  .tt-arrow { font-size: 8px; opacity: 0.6; }
  
  .tt-divider { width: 1px; height: 16px; background: #eee; }

  /* æ»‘å—æ ·å¼ */
  .tt-slider {
      -webkit-appearance: none; height: 4px; background: #eee; border-radius: 2px; flex: 1;
  }
  .tt-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 12px; height: 12px;
      background: #fff; border: 2px solid #ccc; border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  /* é¢œè‰²ç‚¹ */
  .tt-color-dot {
      width: 18px; height: 18px; border-radius: 50%; cursor: pointer;
      border: 2px solid rgba(0,0,0,0.05);
      transition: transform 0.2s; flex-shrink: 0;
  }
  .tt-color-dot:active { transform: scale(0.8); }

  /* è‰²ç›¸ & é¥±å’Œåº¦ & äº®åº¦æ¡ */
  .tt-custom-wrap { 
      flex: 1; display: flex; flex-direction: column; gap: 8px; margin-left: 8px; 
      background: #fafafa; padding: 8px 10px; border-radius: 8px; border: 1px solid #eee;
  }
  .tt-slider-row { display: flex; align-items: center; gap: 8px; font-size: 10px; color: #aaa; }
  
  /* è‰²ç›¸æ¡ï¼šå…¨å…‰è°± */
  .tt-hue-slider {
      -webkit-appearance: none; width: 100%; height: 6px; border-radius: 4px;
      background: linear-gradient(to right, #FF0000, #FFFF00, #00FF00, #00FFFF, #0000FF, #FF00FF, #FF0000);
      opacity: 0.9;
  }
  
  /* é¥±å’Œåº¦æ¡ï¼šJSåŠ¨æ€æ§åˆ¶èƒŒæ™¯ */
  .tt-sat-slider {
      -webkit-appearance: none; width: 100%; height: 6px; border-radius: 4px;
      background: #eee; 
      opacity: 0.9;
  }

  /* äº®åº¦æ¡ï¼šJSåŠ¨æ€æ§åˆ¶èƒŒæ™¯ */
  .tt-light-slider {
      -webkit-appearance: none; width: 100%; height: 6px; border-radius: 4px;
      background: #eee; 
      opacity: 0.9;
  }
  
  .tt-color-thumb::-webkit-slider-thumb {
      -webkit-appearance: none; width: 12px; height: 12px;
      background: #fff; border: 1px solid rgba(0,0,0,0.2); border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }

  /* æ ‡é¢˜ä¸“å±å­—ä½“èœå• */
  #title-font-menu {
      position: absolute; top: 45px; left: 10px;
      background: rgba(255,255,255,0.98);
      border: 1px solid #eee;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 5px;
      max-height: 200px; overflow-y: auto;
      display: none;
      z-index: 100;
      width: 140px;
  }
  .tt-font-item {
      padding: 8px; font-size: 14px; color: #666; cursor: pointer; border-radius: 4px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .tt-font-item:hover { background: #f9f9f9; color: var(--primary); }


  /* æ­£æ–‡åŒº */
  #mode-note {
    min-height: 50vh; outline: none; line-height: 1.8; color: var(--text-main); white-space: pre-wrap;
  }
  #mode-note:empty:before { content: 'âœ¨ éšæ‰‹è®°ç‚¹ä»€ä¹ˆ...'; color: #ddd; }


  #mode-chat { display: none; flex-direction: column; padding-bottom: 120px; }

  .bubble-wrap { display: flex; margin-bottom: 15px; position: relative; width: 100%; }
  .bubble {
    padding: 12px 16px; font-size: inherit; line-height: 1.6; outline: none;
    word-break: break-all; position: relative; transition: background 0.5s;
  }

  .bubble-wrap.left { justify-content: flex-start; }
  .left .bubble {
    background: transparent; border-bottom: 2px dashed #eee;
    color: var(--text-main); width: 95%; padding-left: 0; border-radius: 0;
  }
  .left .bubble:focus { border-bottom-color: var(--primary); }
  .left .bubble.empty-state { color: #bbb !important; font-style: italic !important; }

  .bubble-wrap.right { justify-content: flex-end; }
  .right .bubble {
    background: var(--bubble-R); border-radius: 18px 18px 2px 18px;
    color: var(--text-bubble-r); /* ä½¿ç”¨æ–°å˜é‡ */
    max-width: 80%;
  }
  .right .bubble:empty { min-height: 1em; min-width: 2em; }

  .del-btn {
    position: absolute; width: 20px; height: 20px;
    background: #f0f0f0; color: #aaa; border-radius: 50%;
    text-align: center; line-height: 20px; font-size: 14px;
    cursor: pointer; z-index: 5;
  }
  .left .del-btn { left: -22px; top: 12px; }
  .right .del-btn { right: -8px; top: -8px; background: var(--primary); color: #fff;}

  .add-btn {
    text-align: center; padding: 15px; border: 2px dashed #f0f0f0; border-radius: 12px;
    color: #ccc; font-size: 13px; cursor: pointer; margin-top: 10px;
  }
  .add-btn:hover { border-color: var(--primary); color: var(--primary); }

  .fab-group {
    position: fixed; bottom: 30px; right: 25px;
    display: flex; flex-direction: column; gap: 15px; z-index: 200;
  }
  .mini-fab {
    width: 40px; height: 40px; background: #fff; border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex; align-items: center; justify-content: center;
    color: #888; font-size: 12px; cursor: pointer; font-weight: bold;
  }
  .main-fab {
    width: 60px; height: 60px; background: var(--primary); border-radius: 50%;
    box-shadow: 0 8px 25px rgba(0,0,0,0.25);
    display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer; transition: background 0.5s;
  }
  @media(min-width: 500px) { .fab-group { right: calc(50% - 240px); } }

  /* ================= 5. å¼¹çª— ================= */
  #modal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.98); z-index: 999;
    flex-direction: column; align-items: center; justify-content: center;
    pointer-events: auto; 
  }
  #modal img {
    max-width: 85%; max-height: 65%;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #eee;
    pointer-events: auto; -webkit-user-select: none; user-select: none;
    -webkit-touch-callout: default;
  }
  .save-tip {
     margin-top: 15px; color: #999; font-size: 14px; letter-spacing: 1px;
     font-weight: 500; animation: fadeIn 1s;
  }
  @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
  .modal-actions { display: flex; gap: 20px; margin-top: 25px;}
  .btn-modal {
    padding: 10px 35px; border-radius: 30px; border: none; font-size: 14px;
    font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .btn-cancel { background: #f5f5f5; color: #555; }

</style>
</head>
<body>

<div id="app-container">
  
  <div class="top-area">
    <header>
      <h1>Mochi Script</h1>
      <div class="toggle-box">
          <div class="toggle-item active" id="tab-note" onclick="mode('note')">éšè®°</div>
          <div class="toggle-item" id="tab-chat" onclick="mode('chat')">å‰§åœº</div>
      </div>
    </header>

    <div class="sub-header">
        <div class="control-row">
            <div class="switch-group">
                <div class="switch-wrap">
                    <input type="checkbox" id="date-switch" class="switch-input" onchange="updateHeaderPreview()">
                    <label for="date-switch" class="switch-label"></label>
                    <span>æ—¥æœŸ</span>
                </div>
                <div class="switch-wrap">
                    <input type="checkbox" id="count-switch" class="switch-input" checked onchange="saveCountState()">
                    <label for="count-switch" class="switch-label"></label>
                    <span>å­—æ•°</span>
                </div>
            </div>
            
            <input type="text" class="header-input" id="header-note" 
                   placeholder="è¾“å…¥æ ‡æ³¨â€¦â€¦" oninput="updateHeaderPreview()">
            
            <div class="font-btn" id="font-btn" onclick="toggleFontMenu()">Aa</div>
        </div>
        
        <div id="font-dropdown">
        </div>
        
        <input type="file" id="h-img-input" accept="image/*" style="display:none" onchange="handleImgChange(this)">
    </div>

    <div class="toolbar">
      <div class="row-func">
          <div class="slider-group">
              <div class="slider-row">
                  <span style="font-size:10px; opacity:0.5; width:15px; text-align:center">T</span>
                  <input type="range" id="range-header" min="14" max="36" value="18" oninput="setHeaderFont(this.value)">
                  <span style="font-size:14px; opacity:0.5; width:15px; text-align:center">T</span>
              </div>
              <div class="slider-row">
                  <span style="font-size:10px; opacity:0.5; width:15px; text-align:center">A</span>
                  <input type="range" id="range-body" min="12" max="24" value="16" oninput="setBodyFont(this.value)">
                  <span style="font-size:14px; opacity:0.5; width:15px; text-align:center">A</span>
              </div>
          </div>

          <div class="btn-grid">
              <button class="icon-btn" onclick="exec('bold')"><b>B</b></button>
              <button class="icon-btn" onclick="exec('italic')"><i>I</i></button>
              
              <button class="icon-btn" id="btn-img-toggle" onclick="toggleImgBox()">
                  <svg id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  <svg id="icon-cross" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="display:none"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>

              <button class="icon-btn" id="btn-title-mode" onclick="toggleTitleBox()" style="font-weight:900; font-size:12px; font-family:'Songti SC', serif">æ ‡</button>
          </div>
      </div>

<div class="row-colors">
           
<div class="marker-palette">
              <span class="marker-icon">ğŸ–Š</span>
              <div class="color-dot" style="background:rgba(255, 216, 228, 0.6)" onmousedown="event.preventDefault()" onclick="setMarker('hl-pink')"></div>
              <div class="color-dot" style="background:rgba(208, 240, 192, 0.6)" onmousedown="event.preventDefault()" onclick="setMarker('hl-green')"></div>
              <div class="color-dot" style="background:rgba(242, 227, 248, 0.6)" onmousedown="event.preventDefault()" onclick="setMarker('hl-purple')"></div>
              <div class="color-dot" style="background:rgba(204, 242, 255, 0.6)" onmousedown="event.preventDefault()" onclick="setMarker('hl-blue')"></div>
              <div class="color-dot" style="background:rgba(255, 250, 205, 0.6)" onmousedown="event.preventDefault()" onclick="setMarker('hl-yellow')"></div>
              <div class="color-dot" style="background:#E8E8E8" onmousedown="event.preventDefault()" onclick="setMarker('hl-gray')"></div>
              <div class="color-dot clear" title="æ¸…é™¤" onmousedown="event.preventDefault()" onclick="setMarker('clear')"></div>
          </div>

          <div class="theme-palette">
              <div class="theme-dot" style="background:#E69A8D; width:14px; height:14px;" 
                   onclick="theme('#E69A8D', '#F9F3F3', '#FBE3E1', '#FCEEEE')"></div>
              <div class="theme-dot" style="background:#92B4A7; width:14px; height:14px;" 
                   onclick="theme('#92B4A7', '#F4F8F6', '#E0ECE7', '#EAF2EE')"></div>
              <div class="theme-dot" style="background:#BCA0BC; width:14px; height:14px;" 
                   onclick="theme('#BCA0BC', '#F7F4F7', '#E8DEE8', '#F1ECF1')"></div>
              <div class="theme-dot" style="background:#9ABCCA; width:14px; height:14px;" 
                   onclick="theme('#9ABCCA', '#F3F7F9', '#E1ECF1', '#EBF2F5')"></div>
              <div class="theme-dot" style="background:#F0C058; width:14px; height:14px;" 
                   onclick="theme('#F0C058', '#FEFBF0', '#FDF5D8', '#FEF9E6')"></div>
              <div class="theme-dot" style="background:#555555; width:14px; height:14px;" 
                   onclick="theme('#555555', '#F5F5F5', '#555555', '#EDEDED', '#FFFFFF')"></div>
          </div>
      </div>
    </div>
  </div>

  <div class="viewport" id="viewport">
    
    <div id="paper-header">
        <div id="header-img-wrap">
            <div id="header-img-preview" onclick="triggerImgUpload()"></div>
            <div id="btn-img-gear" onclick="toggleImgToolbar(event)">
                 <svg width="100%" height="100%" viewBox="0 0 24 24" fill="currentColor" style="color:#aaa;">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                 </svg>
            </div>
            <div id="img-toolbar">
                <div class="img-row">
                    <span>Opacity</span>
                    <input type="range" class="img-slider" min="0" max="100" value="100" oninput="setImgOpacity(this.value)">
                </div>
                <div class="img-row presets">
                     <div class="preset-img" id="btn-gpt" onclick="setPresetImg('gpt')" title="GPT"></div>
                     <div class="preset-img" id="btn-gemini" onclick="setPresetImg('gemini')" title="Gemini"></div>
                     <div class="preset-img" id="btn-claude" onclick="setPresetImg('claude')" title="Claude"></div>
                </div>
                <div class="img-color-row">
                    <div class="img-color-dot" style="background:linear-gradient(135deg, #eee 0%, #aaa 100%);" onclick="setImgColorMode('original')" title="åŸè‰²"></div>
                    <div class="img-color-dot" style="background:#333;" onclick="setImgColorMode('black')" title="é»‘è‰²"></div>
                    <div class="img-color-dot" style="background:var(--primary);" onclick="setImgColorMode('theme')" title="ä¸»é¢˜è‰²"></div>
                    <div class="img-color-dot" style="background:var(--bubble-R);" onclick="setImgColorMode('bubble')" title="æ°”æ³¡è‰²"></div>
                </div>
            </div>
        </div>
        
        <div class="header-text-col">
            <span class="preview-note" id="p-note"></span>
            <span class="preview-date" id="p-date"></span>
        </div>
    </div>

    <div id="title-container">
        <div id="btn-title-gear" onclick="toggleTitleToolbarPanel()">
             <svg width="100%" height="100%" viewBox="0 0 24 24" fill="currentColor" style="color:#888;">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
             </svg>
        </div>
        <div id="title-box-wrap" contenteditable="true" oninput="saveTitleText()"></div>
    </div>
    
    <div id="title-toolbar">
        <div class="tt-row">
            <div class="tt-btn font-family-btn" onclick="toggleTitleFontMenu(event)">Aa <span class="tt-arrow">â–¼</span></div>
            <div class="tt-divider"></div>
            <div class="tt-btn" id="tt-bold" onclick="toggleTitleStyle('bold')">B</div>
            <div class="tt-btn" id="tt-italic" onclick="toggleTitleStyle('italic')">I</div>
            <div class="tt-divider"></div>
            <span style="font-size:10px; color:#aaa;">T</span>
            <input type="range" class="tt-slider" id="tt-size-slider" min="16" max="48" step="1" oninput="setTitleSize(this.value)">
        </div>

        <div class="tt-row" style="margin-top:8px; align-items:flex-start;">
            <div style="display:flex; gap:6px; margin-top:10px;">
                <div class="tt-color-dot" style="background:#333" onclick="setTitleColor('black')" title="é»˜è®¤é»‘"></div>
                <div class="tt-color-dot" style="background:var(--primary)" onclick="setTitleColor('theme')" title="è·Ÿéšä¸»é¢˜"></div>
                <div class="tt-color-dot" style="background:var(--bubble-R)" onclick="setTitleColor('bubble')" title="è·Ÿéšæ°”æ³¡"></div>
            </div>
            
            <div class="tt-custom-wrap">
                <div class="tt-slider-row">
                    <span>H</span>
                    <input type="range" class="tt-hue-slider tt-color-thumb" id="tt-hue" min="0" max="360" oninput="setTitleColor('customHue', this.value)">
                </div>
                <div class="tt-slider-row">
                    <span>S</span>
                    <input type="range" class="tt-sat-slider tt-color-thumb" id="tt-sat" min="0" max="100" oninput="setTitleColor('customSat', this.value)">
                </div>
                <div class="tt-slider-row">
                    <span>L</span>
                    <input type="range" class="tt-light-slider tt-color-thumb" id="tt-light" min="0" max="100" oninput="setTitleColor('customLight', this.value)">
                </div>
            </div>
        </div>

        <div id="title-font-menu"></div>
    </div>

    <div id="mode-note" contenteditable="true"></div>
    <div id="mode-chat">
        <div id="chat-stream"></div>
        <div class="add-btn" onclick="add()">+ æ·»åŠ å¯¹è¯è¡Œ</div>
    </div>
  </div>

  <div class="fab-group">
      <div class="mini-fab" onclick="toTop()">TOP</div>
      <div class="mini-fab" onclick="toBottom()">END</div>
      <div class="main-fab" onclick="exportImg()">
         <svg width="24" height="24" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
  </div>

</div>

<div id="modal">
    <img id="res-img" src="">
    <div class="save-tip">é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡å¯ä¿å­˜åˆ°ç›¸å†Œ</div>
    <div class="modal-actions">
        <button class="btn-modal btn-cancel" onclick="document.getElementById('modal').style.display='none'">å…³é—­ / ç»§ç»­ç¼–è¾‘</button>
    </div>
</div>

<script>
    let curMode = 'note';
    let turn = 0; 
    const DEFAULT_TXT = "è¯·è¾“å…¥â€¦â€¦";
    
    // å…¨å±€ä¿å­˜å½“å‰çš„ä¸»é¢˜è‰²å’Œæ°”æ³¡è‰²Hexï¼Œç”¨äºè®¡ç®—
    let currentThemeHex = '#E69A8D';
    let currentBubbleHex = '#FBE3E1';
    
    // å›¾ç‰‡é…ç½®
    let imgConfig = {
        opacity: 100,
        colorMode: 'original', // original, black, theme, bubble
        activeLogo: null // è®°å½•å½“å‰é€‰ä¸­çš„æ˜¯å“ªä¸ªlogo
    };
    
    // --- åŸç”Ÿ SVG æ•°æ® ---
    const LOGOS = {
        gpt: {
            viewBox: "0 0 1024 1024",
            path: "M552.77 960c-58.84-1.12-114.3-24.21-159.26-70.86-4.22-4.38-8.05-3.69-12.76-2.93-113.3 18.34-219.67-43.88-257.22-150.97-15.68-44.72-16.31-90.08-2.45-135.46 1.46-4.79 0.85-8-2.52-11.92-110.11-128.08-45.23-325.85 120-365.79 5.58-1.35 8.24-3.8 10.18-9.12 33.89-92.71 125.98-153.32 225.68-148.71 61.34 2.84 113.42 26.1 155.99 69.81 3.7 3.8 7.18 4.39 11.99 3.59 109.43-18.18 212.22 38.06 253.83 139.27 19.6 47.69 21.6 96.53 7.04 145.92-1.66 5.63-1.03 9.39 2.9 14 109.09 127.73 44.07 324.86-120.37 364.91-5.93 1.45-8.66 4.11-10.68 9.61C742.2 900.66 654.86 960.63 552.77 960z m177.1-317.31h0.04c0-33.52-0.18-67.04 0.16-100.56 0.06-6.12-2.1-9.28-7.29-12.15-20.62-11.38-41-23.18-61.47-34.82-9.2-5.23-9.22-5.22-9.22 5.01-0.03 74.74-0.36 149.48 0.14 224.22 0.11 16.9-6.2 27.77-21.06 36.06-57.97 32.35-115.53 65.43-173.25 98.23-7.05 4.01-7.11 4.09-0.32 9.04 29.15 21.28 61.79 32.41 98.11 33.51 94.25 2.85 173.38-72.13 174.12-165.43 0.25-31.04 0.04-62.07 0.04-93.11zM562.89 380.9c4.12 2.44 6.87 4.14 9.67 5.74 65.31 37.23 130.48 74.69 196.04 111.48 14.6 8.2 20.95 18.87 20.83 35.46-0.5 65.32-0.21 130.64-0.2 195.97 0 10.09 0.06 10.17 9.06 6.22 37.72-16.54 66.15-42.66 84.36-79.48 14.26-28.83 20.59-59.17 16.95-91.04-6.77-59.33-37.54-102.98-89.92-132.4-52-29.21-103.95-58.51-155.41-88.62-10.29-6.02-17.54-6.29-27.56-0.02-20.32 12.72-41.56 24.01-63.82 36.69z m10.55-219.72c-42.3-32.68-88.9-45.43-140.36-35.84-82.31 15.34-138.09 82.91-138.71 166.77-0.47 63.57-0.05 127.15-0.2 190.73-0.01 5.07 1.51 8.06 6.11 10.61 21.26 11.78 42.3 23.95 63.42 35.96 8.41 4.78 8.44 4.77 8.44-4.79 0.01-76.24 0.08-152.48-0.06-228.72-0.03-13.76 5.55-23.56 17.76-30.4 33.67-18.86 67.12-38.08 100.66-57.15 27.2-15.46 54.39-30.93 82.94-47.17zM423.16 403.1c3.83-2.12 6.66-3.66 9.46-5.25 64.65-36.83 129.51-73.32 193.79-110.76 16.62-9.68 30.57-9.21 46.95 0.36 56.65 33.13 113.93 65.21 170.82 97.94 5.82 3.35 7.02 1.65 7.6-3.82 1.91-17.89 1.68-35.7-2.07-53.36-24.13-113.69-148.73-170.17-251.3-113.36-57.2 31.68-113.64 64.72-170.52 96.96-4.15 2.35-5.36 5.08-5.34 9.51 0.16 25.08 0.07 50.16 0.09 75.24 0 1.7 0.26 3.4 0.52 6.54z m37.99 239.22c-3.22-1.95-5.1-3.15-7.04-4.25-66.2-37.68-132.3-75.53-198.69-112.88-14.2-7.99-20.8-18.6-20.69-34.88 0.42-65.57 0.18-131.14 0.17-196.7 0-9.49-0.15-9.75-8.75-5.77-62.65 29.01-98.34 77.66-101.97 145.77-3.45 64.64 24.05 116.47 79.95 150.53 57.3 34.92 116.43 66.9 174.75 100.19 2.47 1.41 4.61 2.41 7.61 0.68 24.49-14.13 49.08-28.1 74.66-42.69z m140.28 23.44V630c0-9.54-0.03-9.58-8.29-4.88-65.73 37.48-131.58 74.76-197.08 112.61-14.62 8.45-27.56 8.77-42.28 0.24-57.65-33.42-115.7-66.17-173.52-99.31-5.03-2.88-6.87-3.23-7.69 3.53-5.01 41.13 3.75 79.21 26.74 113.61 49.29 73.73 146.58 96.84 225.82 53.21 57.51-31.66 114.2-64.77 171.33-97.1 3.82-2.16 5.13-4.69 5.05-8.9-0.24-12.41-0.08-24.83-0.08-37.25z m-0.21-154.58c0-14.65-0.15-29.31 0.09-43.95 0.07-4.49-1.3-7.21-5.38-9.51-26.42-14.86-52.75-29.9-78.97-45.11-3.82-2.22-6.67-1.99-10.33 0.12-26.04 15.03-52.12 29.99-78.34 44.71-4.3 2.41-5.88 5.17-5.85 10 0.2 29.3 0.2 58.61 0 87.91-0.04 5.06 1.51 8.02 6.12 10.59 26.25 14.67 52.34 29.61 78.34 44.7 3.82 2.21 6.55 1.96 10.19-0.15 26.25-15.16 52.57-30.21 79.01-45.05 4.15-2.33 5.27-5.15 5.21-9.57-0.23-14.89-0.09-29.79-0.09-44.69z",
            color: "#000000"
        },
        gemini: {
            viewBox: "0 0 1024 1024",
            path: "M960 512.896A477.248 477.248 0 0 0 512.896 960h-1.792A477.184 477.184 0 0 0 64 512.896v-1.792A477.184 477.184 0 0 0 511.104 64h1.792A477.248 477.248 0 0 0 960 511.104z",
            color: "#448AFF"
        },
        claude: {
            viewBox: "0 0 1024 1024",
            path: "M198.4 678.4l198.4-115.2 6.4-12.8H243.2l-96-6.4-102.4-6.4-19.2-6.4-25.6-25.6v-12.8l19.2-12.8h32l64 6.4 96 6.4 70.4 6.4L384 512h19.2V492.8l-6.4-6.4-102.4-64-108.8-76.8-51.2-38.4-32-19.2-19.2-25.6-6.4-38.4 32-32h44.8l38.4 32 83.2 64L384 364.8l12.8 12.8 6.4-6.4-6.4-12.8L339.2 256l-64-108.8-25.6-38.4-6.4-25.6c0-12.8-6.4-19.2-6.4-32l32-44.8 19.2-6.4 44.8 6.4 19.2 12.8 25.6 57.6 44.8 96 64 128 19.2 38.4 6.4 38.4 6.4 12.8h6.4V384l6.4-70.4 12.8-89.6 12.8-115.2 6.4-32 19.2-38.4 32-19.2 25.6 12.8 19.2 32v19.2l-32 70.4-19.2 121.6-19.2 83.2h6.4l12.8-12.8 44.8-57.6 70.4-89.6 32-32 38.4-38.4 25.6-19.2h44.8l32 51.2-12.8 51.2-51.2 57.6-38.4 51.2-51.2 70.4-38.4 57.6v6.4h6.4l121.6-25.6 64-12.8 76.8-12.8 38.4 19.2 6.4 19.2-12.8 32-83.2 19.2-96 19.2-147.2 32 64 6.4h96l128 6.4 32 19.2 25.6 38.4-6.4 19.2-51.2 25.6-70.4-12.8-160-38.4-57.6-12.8h-6.4v6.4l44.8 44.8 83.2 76.8 108.8 102.4 6.4 25.6-12.8 19.2h-12.8l-96-70.4-38.4-32-83.2-70.4h-6.4v6.4l19.2 25.6 102.4 147.2 6.4 44.8-6.4 12.8-25.6 6.4-25.6-6.4-57.6-83.2-64-83.2-51.2-83.2-6.4 6.4-25.6 307.2-12.8 12.8-32 12.8-25.6-19.2-12.8-32 12.8-64 19.2-83.2 12.8-64 12.8-83.2 6.4-25.6h-6.4l-64 83.2-96 128-70.4 76.8-19.2 6.4-32-12.8v-25.6l19.2-25.6 102.4-128 64-83.2 38.4-51.2v-6.4l-268.8 172.8-51.2 12.8-19.2-19.2v-32l12.8-12.8 76.8-57.6z m0 0",
            color: "#D97757"
        }
    };

    const fonts = [
{ name: 'æ€æºé»‘ä½“', val: '"PingFang SC", "Noto Sans SC", sans-serif' },
    { name: 'æ€æºå®‹ä½“', val: '"Songti SC", "Noto Serif SC", serif' },
        { name: 'Pinyon Script', val: "'Pinyon Script', cursive" },
        { name: 'Great Vibes', val: "'Great Vibes', cursive" },
        { name: 'Parisienne', val: "'Parisienne', cursive" },
        { name: 'Allura', val: "'Allura', cursive" },
        { name: 'Petit Formal', val: "'Petit Formal Script', cursive" },
        { name: 'Monsieur La', val: "'Monsieur La Doulaise', cursive" },
        { name: 'Qwigley', val: "'Qwigley', cursive" },
        { name: 'Sacramento', val: "'Sacramento', cursive" },
        { name: 'Ephesis', val: "'Ephesis', cursive" },
        { name: 'Unifraktur', val: "'UnifrakturMaguntia', cursive" },
        { name: 'Tangerine', val: "'Tangerine', cursive" },
        { name: 'Pacifico', val: "'Pacifico', cursive" },
        { name: 'Dancing Script', val: "'Dancing Script', cursive" },
    ];
    let currentFont = fonts[0].val;
    let bodyFontVal = 16;
    let headerFontVal = 18;
    
    let isImgBoxOpen = false;

    window.onload = function() {
        const savedNote = localStorage.getItem('mochi_note_text');
        const savedDateOn = localStorage.getItem('mochi_date_on');
        const savedCountOn = localStorage.getItem('mochi_count_on');
        const savedFont = localStorage.getItem('mochi_font_val');
        const savedBodySize = localStorage.getItem('mochi_body_size');
        const savedHeaderSize = localStorage.getItem('mochi_header_size');
        const savedImgSrc = localStorage.getItem('mochi_header_img_src');
        const savedImgOpacity = localStorage.getItem('mochi_img_opacity');
        const savedActiveLogo = localStorage.getItem('mochi_active_logo');
        const savedColorMode = localStorage.getItem('mochi_img_color_mode');
        
        if(savedImgSrc) {
            document.getElementById('header-img-preview').style.backgroundImage = `url(${savedImgSrc})`;
        }
        
        if(savedImgOpacity) {
            imgConfig.opacity = parseInt(savedImgOpacity);
            document.querySelector('.img-slider').value = imgConfig.opacity;
            setImgOpacity(imgConfig.opacity);
        }
        
        if(savedActiveLogo) imgConfig.activeLogo = savedActiveLogo;
        if(savedColorMode) imgConfig.colorMode = savedColorMode;

        if(savedNote) document.getElementById('header-note').value = savedNote;
        if(savedDateOn === 'true') document.getElementById('date-switch').checked = true;
        if(savedCountOn === 'false') document.getElementById('count-switch').checked = false;

        if(savedFont) {
            currentFont = savedFont;
            document.documentElement.style.setProperty('--header-font', currentFont);
        }

        if(savedBodySize) {
            bodyFontVal = parseInt(savedBodySize);
            document.getElementById('range-body').value = bodyFontVal;
        }
        if(savedHeaderSize) {
            headerFontVal = parseInt(savedHeaderSize);
            document.getElementById('range-header').value = headerFontVal;
        }

        setBodyFont(bodyFontVal);
        setHeaderFont(headerFontVal); 

        initFontMenu();
        
        // --- åˆå§‹åŒ–é¢„è®¾å›¾æ ‡æŒ‰é’®èƒŒæ™¯ ---
        // æŒ‰é’®æœ¬èº«å§‹ç»ˆæ˜¾ç¤ºåŸè‰²ï¼Œä¸å—å½“å‰æ¨¡å¼å½±å“
        document.getElementById('btn-gpt').style.backgroundImage = createSvgUrl('gpt', 'original');
        document.getElementById('btn-gemini').style.backgroundImage = createSvgUrl('gemini', 'original');
        document.getElementById('btn-claude').style.backgroundImage = createSvgUrl('claude', 'original');
        
        add(DEFAULT_TXT, 'left'); 
        setTimeout(()=>{ add("", 'right'); }, 50); 
        document.getElementById('mode-note').addEventListener('paste', cleanPaste);

        document.addEventListener('click', function(e) {
            const btn = document.getElementById('font-btn');
            const menu = document.getElementById('font-dropdown');
            if (!btn.contains(e.target) && !menu.contains(e.target)) {
                menu.style.display = 'none';
                btn.classList.remove('active');
            }
        });
        
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('img-toolbar');
            const gear = document.getElementById('btn-img-gear');
            if(panel && panel.style.display==='flex' && !panel.contains(e.target) && !gear.contains(e.target)) {
                panel.style.display = 'none';
            }
        });

        loadTitleSettings();
        initTitleFontMenu();
        
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('title-font-menu');
            const btn = document.querySelector('.font-family-btn');
            if (menu && menu.style.display === 'block' && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
            }
        });
        
        const savedTitleText = localStorage.getItem('mochi_title_text');
        if(savedTitleText) document.getElementById('title-box-wrap').innerText = savedTitleText;
    };

    // --- æ ¸å¿ƒï¼šSVG ç”Ÿæˆå™¨ (ä¿®æ”¹ç‰ˆï¼šæ”¯æŒé¢œè‰²è¦†ç›–) ---
    function createSvgUrl(key, overrideMode) {
        const data = LOGOS[key];
        if(!data) return '';
        
        let fillColor = data.color; // é»˜è®¤åŸè‰²
        
        // ç¡®å®šä½¿ç”¨ä»€ä¹ˆæ¨¡å¼ï¼šå¦‚æœæ˜¯ç”ŸæˆæŒ‰é’®å›¾æ ‡ï¼Œå¼ºåˆ¶ç”¨åŸè‰²ï¼›å¦åˆ™ç”¨å…¨å±€é…ç½®
        const mode = overrideMode || imgConfig.colorMode;
        
        if (mode === 'black') fillColor = '#000000';
        else if (mode === 'theme') fillColor = currentThemeHex;
        else if (mode === 'bubble') fillColor = currentBubbleHex;
        
        // æ„é€  SVG å­—ç¬¦ä¸²
        const svgString = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${data.viewBox}"><path d="${data.path}" fill="${fillColor}"/></svg>`;
        return "url('data:image/svg+xml;utf8," + encodeURIComponent(svgString) + "')";
    }

    function initFontMenu() {
        const menu = document.getElementById('font-dropdown');
        fonts.forEach(f => {
            const item = document.createElement('div');
            item.className = 'font-item';
            item.style.fontFamily = f.val;
            item.innerText = f.name;
            if(f.val === currentFont) item.classList.add('selected');
            item.onclick = () => { selectFont(f.val, item); };
            menu.appendChild(item);
        });
    }

    function toggleFontMenu() {
        const menu = document.getElementById('font-dropdown');
        const btn = document.getElementById('font-btn');
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
            btn.classList.remove('active');
        } else {
            menu.style.display = 'block';
            btn.classList.add('active');
        }
    }

    function selectFont(fontVal, domItem) {
        currentFont = fontVal;
        document.documentElement.style.setProperty('--header-font', fontVal);
        localStorage.setItem('mochi_font_val', fontVal);
        
        document.querySelectorAll('.font-item').forEach(el => el.classList.remove('selected'));
        domItem.classList.add('selected');
        
        document.getElementById('font-dropdown').style.display = 'none';
        document.getElementById('font-btn').classList.remove('active');
    }

    function setBodyFont(v) { 
        bodyFontVal = v;
        document.getElementById('viewport').style.fontSize = v + 'px'; 
        localStorage.setItem('mochi_body_size', v);
    }

    function setHeaderFont(v) {
        headerFontVal = v;
        updateHeaderPreview(); 
        localStorage.setItem('mochi_header_size', v);
    }

    function saveCountState() {
        const isOn = document.getElementById('count-switch').checked;
        localStorage.setItem('mochi_count_on', isOn);
    }

    function updateHeaderPreview() {
        const inputVal = document.getElementById('header-note').value;
        const isDateOn = document.getElementById('date-switch').checked;
        const previewDiv = document.getElementById('paper-header');
        const pNote = document.getElementById('p-note');
        const pDate = document.getElementById('p-date');
        
        const imgWrap = document.getElementById('header-img-wrap');
        const textCol = document.querySelector('.header-text-col');
        
        localStorage.setItem('mochi_note_text', inputVal);
        localStorage.setItem('mochi_date_on', isDateOn);

        const shouldShow = inputVal || isDateOn || isImgBoxOpen;

        if(!shouldShow) {
            previewDiv.style.display = 'none';
        } else {
            previewDiv.style.display = 'flex'; 
            
            pNote.innerText = inputVal;
            pNote.style.fontSize = headerFontVal + 'px'; 
if(isDateOn) {
        const d = new Date();
        // ä¿®æ”¹åï¼šå¢åŠ äº† padStart(2, '0') æ¥è‡ªåŠ¨è¡¥é›¶
        const yy = d.getFullYear();
        const mm = (d.getMonth() + 1).toString().padStart(2, '0');
        const dd = d.getDate().toString().padStart(2, '0');
        
        const dateStr = `${yy}.${mm}.${dd}`; // ç»“æœä¾‹å¦‚ï¼š2025.01.05
        
        pDate.innerText = dateStr;
        pDate.style.display = 'block';
        pDate.style.fontSize = (headerFontVal * 0.7) + 'px'; 
    } else {
                pDate.style.display = 'none';
            }
            
            // --- æ™ºèƒ½ Logo å°ºå¯¸é€»è¾‘ ---
            const imgBox = document.getElementById('header-img-preview');
            const h = textCol.offsetHeight; 
            
            // å¦‚æœæ–‡å­—åŒºåŸŸæœ‰é«˜åº¦ï¼ˆè¯´æ˜æœ‰æ–‡å­—æˆ–æ—¥æœŸï¼‰ï¼Œåˆ™è·Ÿéšé«˜åº¦
            // å¦åˆ™ï¼ˆè¯´æ˜ä»…æ˜¾ç¤ºLogoï¼‰ï¼Œå›ºå®šä¸º 30px
            const finalSize = (h > 0) ? h : 30;
            
            imgBox.style.width = finalSize + 'px';
            imgBox.style.height = finalSize + 'px';
        }
    }

    function toggleImgBox() {
        const wrap = document.getElementById('header-img-wrap');
        const box = document.getElementById('header-img-preview');
        const plus = document.getElementById('icon-plus');
        const cross = document.getElementById('icon-cross');
        
        isImgBoxOpen = !isImgBoxOpen;
        
        if(isImgBoxOpen) {
            wrap.style.display = 'block'; 
            box.style.display = 'block';
            plus.style.display = 'none';
            cross.style.display = 'block';
        } else {
            wrap.style.display = 'none';
            box.style.display = 'none';
            plus.style.display = 'block';
            cross.style.display = 'none';
            document.getElementById('img-toolbar').style.display='none'; 
        }
        updateHeaderPreview(); 
    }

    function triggerImgUpload() {
        document.getElementById('h-img-input').click();
    }

    function handleImgChange(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const src = e.target.result;
                document.getElementById('header-img-preview').style.backgroundImage = `url(${src})`;
                localStorage.setItem('mochi_header_img_src', src);
                imgConfig.activeLogo = null; // æ¸…é™¤é¢„è®¾é€‰ä¸­çŠ¶æ€
            }
            reader.readAsDataURL(input.files[0]);
        }
input.value = '';
    }
    
    // --- å›¾ç‰‡æ§åˆ¶é€»è¾‘ ---
    function toggleImgToolbar(e) {
        e.stopPropagation();
        const tb = document.getElementById('img-toolbar');
        if(tb.style.display === 'flex') {
            tb.style.display = 'none';
        } else {
            tb.style.display = 'flex';
        }
    }
    
    function setImgOpacity(val) {
        imgConfig.opacity = val;
        document.getElementById('header-img-preview').style.opacity = val / 100;
        localStorage.setItem('mochi_img_opacity', val);
    }
    
    // åˆ‡æ¢ Logo
    function setPresetImg(type) {
        imgConfig.activeLogo = type;
        localStorage.setItem('mochi_active_logo', type);
        refreshLogo();
    }
    
    // åˆ‡æ¢é¢œè‰²æ¨¡å¼
    function setImgColorMode(mode) {
        imgConfig.colorMode = mode;
        localStorage.setItem('mochi_img_color_mode', mode);
        refreshLogo();
    }
    
    // ç»Ÿä¸€åˆ·æ–° Logo æ˜¾ç¤º
    function refreshLogo() {
        if(imgConfig.activeLogo) {
            const url = createSvgUrl(imgConfig.activeLogo);
            document.getElementById('header-img-preview').style.backgroundImage = url;
            localStorage.setItem('mochi_header_img_src', url);
        }
    }


    // --- æ ‡é¢˜æ¨¡å¼é€»è¾‘ ---
    function toggleTitleBox() {
        const titleContainer = document.getElementById('title-container');
        const titleBox = document.getElementById('title-box-wrap');
        const toolbar = document.getElementById('title-toolbar'); 
        const btn = document.getElementById('btn-title-mode');
        
        if (titleContainer.style.display === 'block') {
            titleContainer.style.display = 'none';
            toolbar.style.display = 'none'; 
            btn.classList.remove('btn-active');
        } else {
            titleContainer.style.display = 'block';
            toolbar.style.display = 'flex'; 
            btn.classList.add('btn-active');
            titleBox.focus();
            
            applyTitleStyles();
        }
    }
    
    function toggleTitleToolbarPanel() {
        const toolbar = document.getElementById('title-toolbar');
        if(toolbar.style.display === 'none') {
            toolbar.style.display = 'flex';
        } else {
            toolbar.style.display = 'none';
        }
    }

    function setMarker(className) {
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed) return; 

        if (className === 'clear') {
            document.execCommand('removeFormat', false, null);
            return;
        }

        const range = sel.getRangeAt(0);
        
        const span = document.createElement('span');
        span.className = className;

        try {
            range.surroundContents(span);
            sel.removeAllRanges();
        } catch (e) {
            console.warn("æ ‡æ³¨å¤±è´¥ï¼šå¯èƒ½è·¨è¶Šäº†æ®µè½è¾¹ç•Œã€‚", e);
        }
    }

    function theme(primary, bgBody, bubbleR, bgTop, bubbleTextCol) {
        currentThemeHex = primary;
        currentBubbleHex = bubbleR;

        const r = document.documentElement.style;
        r.setProperty('--primary', primary);
        r.setProperty('--bg-body', bgBody);
        r.setProperty('--bubble-R', bubbleR);
        r.setProperty('--bg-top', bgTop);

        if(bubbleTextCol) {
            r.setProperty('--text-bubble-r', bubbleTextCol);
        } else {
            r.setProperty('--text-bubble-r', 'var(--text-main)');
        }
        
        if(titleConfig.colorMode === 'theme') setTitleColor('theme');
        if(titleConfig.colorMode === 'bubble') setTitleColor('bubble');
        
        // å¦‚æœå›¾ç‰‡ä½¿ç”¨äº†ä¸»é¢˜è‰²æˆ–æ°”æ³¡è‰²ï¼Œåˆ‡æ¢ä¸»é¢˜æ—¶ä¹Ÿè¦åˆ·æ–°å›¾ç‰‡
        if(imgConfig.activeLogo && (imgConfig.colorMode === 'theme' || imgConfig.colorMode === 'bubble')) {
            refreshLogo();
        }
    }

    function mode(m) {
        curMode = m;
        const n = document.getElementById('mode-note');
        const c = document.getElementById('mode-chat');
        const tn = document.getElementById('tab-note');
        const tc = document.getElementById('tab-chat');
        
        if(m==='note') {
            n.style.display='block'; c.style.display='none';
            tn.className='toggle-item active'; tc.className='toggle-item';
        } else {
            n.style.display='none'; c.style.display='flex';
            tn.className='toggle-item'; tc.className='toggle-item active';
        }
    }
    
    function exec(c) { document.execCommand(c, false, null); }
    
    function cleanPaste(e) {
        e.preventDefault();
        const t = (e.clipboardData || window.clipboardData).getData('text');
        document.execCommand('insertText', false, t);
    }

    function toTop() { document.getElementById('viewport').scrollTo({top:0, behavior:'smooth'}); }
    function toBottom() { const v = document.getElementById('viewport'); v.scrollTo({top:v.scrollHeight, behavior:'smooth'}); }

    function add(initialText, forceSide) {
        const s = document.getElementById('chat-stream');
        let isL;
        if(forceSide) {
            isL = (forceSide === 'left');
            turn = (isL ? 0 : 1); 
        } else {
            isL = (turn % 2 === 0);
        }

        const d = document.createElement('div');
        d.className = `bubble-wrap ${isL?'left':'right'}`;
        
        const del = document.createElement('div');
        del.className = 'del-btn'; del.innerText = 'Ã—';
        del.onclick = function(){ d.remove(); };

        const b = document.createElement('div');
        b.className = 'bubble';
        b.contentEditable = true;
        
        if(isL) {
            if(!initialText || initialText === DEFAULT_TXT) {
                b.innerText = DEFAULT_TXT;
                b.classList.add('empty-state');
            } else {
                b.innerText = initialText;
            }
            b.onfocus = function() {
                if(this.innerText === DEFAULT_TXT) {
                    this.innerText = "";
                    this.classList.remove('empty-state');
                }
            };
            b.onblur = function() {
                if(this.innerText.trim() === "") {
                    this.innerText = DEFAULT_TXT;
                    this.classList.add('empty-state');
                }
            };
        } else {
            b.innerText = initialText || "";
        }

        b.addEventListener('paste', cleanPaste);
        d.appendChild(del); d.appendChild(b); s.appendChild(d);
        turn++; 
        setTimeout(toBottom, 100);
    }

    // ================= æ ‡é¢˜ç‹¬ç«‹æ§åˆ¶é€»è¾‘ =================

    let titleConfig = {
        font: fonts[0].val, 
        size: 24,           
        bold: true,         
        italic: false,      
        colorMode: 'black', 
        customHue: 0,       
        customSat: 0,       
        customLight: 20     
    };

    function hexToHSL(hex) {
        hex = hex.replace(/^#/, '');
        let r = parseInt(hex.substring(0, 2), 16) / 255;
        let g = parseInt(hex.substring(2, 4), 16) / 255;
        let b = parseInt(hex.substring(4, 6), 16) / 255;

        let max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;

        if (max === min) {
            h = s = 0; 
        } else {
            let d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
                case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                case g: h = (b - r) / d + 2; break;
                case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
        }
        return {
            h: Math.round(h * 360),
            s: Math.round(s * 100),
            l: Math.round(l * 100)
        };
    }

    function loadTitleSettings() {
        const saved = localStorage.getItem('mochi_title_config');
        if(saved) {
            const loaded = JSON.parse(saved);
            titleConfig = { ...titleConfig, ...loaded };
            if(titleConfig.customLight === undefined) titleConfig.customLight = 60;
        }
        updateTitleUIState();
        applyTitleStyles();
    }

    function saveTitleSettings() {
        localStorage.setItem('mochi_title_config', JSON.stringify(titleConfig));
        applyTitleStyles();
        updateTitleUIState();
    }
    
    function saveTitleText() {
        const t = document.getElementById('title-box-wrap').innerText;
        localStorage.setItem('mochi_title_text', t);
    }

    function applyTitleStyles() {
        const box = document.getElementById('title-box-wrap');
        if(!box) return;

        box.style.fontFamily = titleConfig.font;
        box.style.fontSize = titleConfig.size + 'px';
        box.style.fontWeight = titleConfig.bold ? 'bold' : 'normal';
        box.style.fontStyle = titleConfig.italic ? 'italic' : 'normal';
        
        let finalHue = titleConfig.customHue;
        let finalSat = titleConfig.customSat;
        let finalLight = titleConfig.customLight;

        box.style.color = `hsl(${finalHue}, ${finalSat}%, ${finalLight}%)`;
        box.style.textShadow = 'none';
    }

    function updateTitleUIState() {
        const btnBold = document.getElementById('tt-bold');
        const btnItalic = document.getElementById('tt-italic');
        
        const sliderHue = document.getElementById('tt-hue');
        const sliderSat = document.getElementById('tt-sat');
        const sliderLight = document.getElementById('tt-light');
        const sliderSize = document.getElementById('tt-size-slider');

        if(btnBold) {
             if(titleConfig.bold) btnBold.classList.add('active'); else btnBold.classList.remove('active');
        }
        if(btnItalic) {
             if(titleConfig.italic) btnItalic.classList.add('active'); else btnItalic.classList.remove('active');
        }
        
        if(sliderSize) sliderSize.value = titleConfig.size;

        if(sliderHue) sliderHue.value = titleConfig.customHue;
        if(sliderSat) sliderSat.value = titleConfig.customSat;
        if(sliderLight) sliderLight.value = titleConfig.customLight;

        if(sliderSat) {
            const h = titleConfig.customHue;
            const l = titleConfig.customLight;
            sliderSat.style.background = `linear-gradient(to right, hsl(${h}, 0%, ${l}%), hsl(${h}, 100%, ${l}%))`;
        }
        
        if(sliderLight) {
            const h = titleConfig.customHue;
            const s = titleConfig.customSat;
            sliderLight.style.background = `linear-gradient(to right, black, hsl(${h}, ${s}%, 50%), white)`;
        }
    }

    function setTitleSize(val) {
        titleConfig.size = val;
        saveTitleSettings();
    }

    function toggleTitleStyle(type) {
        if(type === 'bold') titleConfig.bold = !titleConfig.bold;
        if(type === 'italic') titleConfig.italic = !titleConfig.italic;
        saveTitleSettings();
    }

    function setTitleColor(mode, val) {
        titleConfig.colorMode = mode;

        if(mode === 'customHue') {
            titleConfig.colorMode = 'custom';
            titleConfig.customHue = val;
        } else if (mode === 'customSat') {
            titleConfig.colorMode = 'custom';
            titleConfig.customSat = val;
        } else if (mode === 'customLight') {
            titleConfig.colorMode = 'custom';
            titleConfig.customLight = val;
        } else if (mode === 'black') {
            titleConfig.customHue = 0;
            titleConfig.customSat = 0;
            titleConfig.customLight = 20; 
        } else if (mode === 'theme') {
            const hsl = hexToHSL(currentThemeHex);
            titleConfig.customHue = hsl.h;
            titleConfig.customSat = hsl.s;
            titleConfig.customLight = hsl.l;
        } else if (mode === 'bubble') {
            const hsl = hexToHSL(currentBubbleHex);
            titleConfig.customHue = hsl.h;
            titleConfig.customSat = hsl.s;
            titleConfig.customLight = hsl.l; 
        }
        
        saveTitleSettings();
    }

    function initTitleFontMenu() {
        const menu = document.getElementById('title-font-menu');
        menu.innerHTML = ''; 
        fonts.forEach(f => {
            const item = document.createElement('div');
            item.className = 'tt-font-item';
            item.innerText = f.name;
            item.style.fontFamily = f.val;
            item.onclick = () => {
                titleConfig.font = f.val;
                saveTitleSettings();
                menu.style.display = 'none';
            };
            menu.appendChild(item);
        });
    }

    function toggleTitleFontMenu(e) {
        e.stopPropagation();
        const menu = document.getElementById('title-font-menu');
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }


    function exportImg() {
        const fab = document.querySelector('.main-fab');
        fab.style.transform = 'scale(0.8)';
        
        document.body.classList.add('printing');

        const rootStyle = getComputedStyle(document.documentElement);
        const p = rootStyle.getPropertyValue('--primary').trim();
        const bR = rootStyle.getPropertyValue('--bubble-R');
        const tm = rootStyle.getPropertyValue('--text-main');
        const textBubble = rootStyle.getPropertyValue('--text-bubble-r') || tm;
        const headerFont = rootStyle.getPropertyValue('--header-font');
        const fsStr = document.getElementById('viewport').style.fontSize || '16px';

        const previewHeaderClone = document.getElementById('paper-header').cloneNode(true);
        previewHeaderClone.style.display = 'flex'; 

        const titleContainer = document.getElementById('title-container');
        let titleBoxClone = null;
        
        const originalTitleBox = document.getElementById('title-box-wrap');
        if (titleContainer.style.display === 'block' && originalTitleBox.innerText.trim() !== '') {
            titleBoxClone = originalTitleBox.cloneNode(true);
            titleBoxClone.style.fontFamily = originalTitleBox.style.fontFamily;
            titleBoxClone.style.fontSize = originalTitleBox.style.fontSize;
            titleBoxClone.style.fontWeight = originalTitleBox.style.fontWeight;
            titleBoxClone.style.fontStyle = originalTitleBox.style.fontStyle;
            titleBoxClone.style.color = originalTitleBox.style.color;
            titleBoxClone.style.textShadow = originalTitleBox.style.textShadow;
            titleBoxClone.style.paddingRight = '10px';
            titleBoxClone.style.border = 'none'; 
            titleBoxClone.style.marginBottom = '15px';
        }

        const source = curMode==='note' ? document.getElementById('mode-note') : document.getElementById('mode-chat');
        const cloneContent = source.cloneNode(true);

        cloneContent.querySelectorAll('.del-btn').forEach(e=>e.remove());
        const addBtn = cloneContent.querySelector('.add-btn');
        if(addBtn) addBtn.style.display='none';

        if(curMode === 'note') {
            cloneContent.style.minHeight = '0px';
            cloneContent.style.height = 'auto';
        } else {
            cloneContent.style.paddingBottom = '0px';
        }

        let footerDiv = null;
        const isCountOn = document.getElementById('count-switch').checked;

        if (isCountOn) {
            const miniFont = "font-size: 8px; font-weight: 300; font-family: -apple-system, sans-serif;";
            let footerHtml = `<span style="color:#999; ${miniFont}">Total</span>`;
            const countText = (str) => str.replace(/\s/g, '').length;

            let totalWords = 0;

            if (originalTitleBox && titleContainer.style.display === 'block') {
                totalWords += countText(originalTitleBox.innerText);
            }

            if (curMode === 'note') {
                totalWords += countText(source.innerText);
                if (totalWords > 0) footerHtml += `<span style="color:#999; ${miniFont}"> Â· ${totalWords}å­—</span>`;
            } else {
                let leftTotal = 0;
                source.querySelectorAll('.left .bubble').forEach(b => {
                    if(!b.classList.contains('empty-state')) leftTotal += countText(b.innerText);
                });
                let rightTotal = 0;
                source.querySelectorAll('.right .bubble').forEach(b => {
                    rightTotal += countText(b.innerText);
                });
                if (leftTotal > 0) footerHtml += `<span style="color:#999; ${miniFont}"> Â· ${leftTotal}å­—</span>`;
                if (rightTotal > 0) footerHtml += `<span style="color:${p}; ${miniFont}"> Â· ${rightTotal}å­—</span>`;
            }

            footerDiv = document.createElement('div');
            footerDiv.innerHTML = footerHtml;
            footerDiv.style.cssText = `text-align: right; margin-top: 30px; width: 100%; line-height: 1.2;`;
        }

        const box = document.createElement('div');
        box.style.cssText = `
            position: fixed; top: -9999px; left: 0; 
            width: 500px; background: #fff; padding: 40px;
            box-sizing: border-box;
            font-family: -apple-system, "PingFang SC", sans-serif; 
            font-size: ${fsStr};
            display: flex; flex-direction: column;
            --primary: ${p}; --bubble-R: ${bR}; --text-main: ${tm};
            --text-bubble-r: ${textBubble};
            --header-font: ${headerFont}; 
        `;
        
        box.appendChild(previewHeaderClone);
        if(titleBoxClone) box.appendChild(titleBoxClone);
        box.appendChild(cloneContent);
        if(footerDiv) box.appendChild(footerDiv);

        document.body.appendChild(box);

        html2canvas(box, {
            scale: 2, useCORS: true, backgroundColor: '#ffffff',
            width: 500, windowWidth: 500
        }).then(canvas => {
            const imgUrl = canvas.toDataURL('image/png');
            document.getElementById('res-img').src = imgUrl;
            document.getElementById('modal').style.display = 'flex';
            document.body.removeChild(box);
            document.body.classList.remove('printing');
            fab.style.transform = 'scale(1)';
        });
    }
</script>
</body>
</html>