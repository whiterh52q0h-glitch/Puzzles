<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>Mochi Note V12.2 White Mode</title>

<link rel="icon" href="icon.jpeg">
<link rel="apple-touch-icon" href="icon.jpeg">
<meta name="apple-mobile-web-app-title" content="Puzzles">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Allura&family=Dancing+Script&family=Ephesis&family=Great+Vibes&family=Monsieur+La+Doulaise&family=Noto+Serif+SC:wght@300&family=Pacifico&family=Parisienne&family=Petit+Formal+Script&family=Pinyon+Script&family=Qwigley&family=Sacramento&family=Tangerine&family=UnifrakturMaguntia&display=swap" rel="stylesheet">

<style>
  /* ğŸŸ¢ ä¿®å¤ï¼šå‰§åœºæ¨¡å¼ä¸­ï¼Œå¦‚æœç¬¬ä¸€å¥è¯åœ¨å³è¾¹ï¼Œå¢åŠ é¡¶éƒ¨è·ç¦» */
  #chat-stream .bubble-wrap.right:first-child {
      margin-top: 20px; 
  }
  
  /* ================= å­—ä½“å¼•å…¥åŒºåŸŸ ================= */
  @font-face { font-family: 'MyLove'; src: url('myfont.ttf'); }
  @font-face { font-family: '5bil91'; src: url('5bil91.otf'); }
  @font-face { font-family: 'AlphaClouds'; src: url('AlphaClouds.ttf'); }
  @font-face { font-family: 'AltGotisch'; src: url('ALTGOTISCH.TTF'); }
  @font-face { font-family: 'JiangCheng'; src: url('jiangchengludongsong.ttf'); }
  @font-face { font-family: 'Koenigsberger'; src: url('koenigsbergergotisch.ttf'); }
  @font-face { font-family: 'LettreEtoile'; src: url('Lettreetoile.ttf'); }
  @font-face { font-family: 'Medicall'; src: url('medicall.TTF'); }
  @font-face { font-family: 'Molyna'; src: url('molyna.TTF'); }
  @font-face { font-family: 'PanNi'; src: url('pannimingchao.ttf'); }
  @font-face { font-family: 'PlumScript'; src: url('Plum Script.TTF'); }
  @font-face { font-family: 'ShanHai'; src: url('shanhaiyinglungetew.ttf'); }
  @font-face { font-family: 'StarHand'; src: url('Star-Hnd.ttf'); }

  :root {
    --primary: #E69A8D;        
    --bg-body: #F9F3F3;        
    --bg-top:  #FCEEEE;        
    --bubble-R: #FBE3E1;      
    --text-main: #5A5A5A;
    --text-bubble-r: #5A5A5A; 
    --card-bg: #FFFFFF;
    --shadow: 0 8px 30px rgba(0,0,0,0.06);
    --header-font: 'MyLove', 'Pinyon Script', cursive;

    /* ğŸŸ¢ æ–°å¢ï¼šèƒŒæ™¯ä¸æ°”æ³¡ç›¸å…³å˜é‡ */
    --bubble-rgb: 251, 227, 225; /* æ°”æ³¡RGBï¼Œç”¨äºé€æ˜åº¦è®¡ç®— */
    --bubble-op: 1;              /* æ°”æ³¡é€æ˜åº¦ */
    --bubble-blur: 0px;          /* æ°”æ³¡æ¨¡ç³Š */
    --global-blur: 0px;          /* å…¨å±€èƒŒæ™¯æ¨¡ç³Š */
    --global-overlay: 0;         /* å…¨å±€èƒŒæ™¯ç™½è†œæµ“åº¦ */
  }

  html, body {
    margin: 0; padding: 0;
    width: 100%; 
    height: 100%; 
    overflow: hidden; 
    background-color: #ffffff;
    font-family: -apple-system, "PingFang SC", sans-serif; 
    color: var(--text-main);
    -webkit-user-select: none; user-select: none;
    position: fixed; 
    top: 0; left: 0;
  }

  #app-container {
    width: 100%; max-width: 500px;
    height: 100%; 
    margin: 0 auto; 
    /* ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šèƒŒæ™¯é€æ˜ï¼Œå¦åˆ™ä¼šæŒ¡ä½åº•ä¸‹çš„æ³¢ç‚¹å’Œå›¾ç‰‡ */
    background-color: transparent;
    display: flex;
    flex-direction: column; 
    box-shadow: var(--shadow);
    position: relative; 
    overflow: hidden; 
    z-index: 1; 
  }

  #bg-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: -2;
      background-size: 100% auto; 
      background-repeat: repeat; 
      background-position: top center;
      /* ğŸ”´ å¼ºåˆ¶ç¦æ­¢è¿‡æ¸¡ï¼Œè§£å†³ç‚¹å‡»å»¶è¿Ÿ */
      transition: none !important; 
      will-change: background-image, opacity;
      pointer-events: none;
      background-color: transparent; 
      opacity: 0.3; 
  }
  
  #bg-mask {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: -1;
      pointer-events: none;
      transition: all 0.2s;
      /* åŠ¨æ€æ ·å¼å°†åœ¨JSä¸­åº”ç”¨ */
      backdrop-filter: blur(var(--global-blur));
      -webkit-backdrop-filter: blur(var(--global-blur));
      background-color: rgba(255, 255, 255, var(--global-overlay));
  }

  [contenteditable="true"], input { -webkit-user-select: text; user-select: text;
  }

  /* ================= é¡¶éƒ¨åŒºåŸŸ ================= */
  .top-area {
    background-color: var(--bg-top);
    transition: background-color 0.5s;
    border-bottom: 1px solid rgba(0,0,0,0.03);
    padding-bottom: 8px; 
    flex-shrink: 0; 
    z-index: 100;
    padding-top: env(safe-area-inset-top);
  }
  
  /* é”®ç›˜å¼¹å‡ºæ—¶éšè—éå…³é”®åŒºåŸŸçš„æ ·å¼ */
  body.keyboard-active .sub-header,
  body.keyboard-active .toolbar {
      display: none !important;
  }
  body.keyboard-active .top-area {
      padding-bottom: 0; 
      border-bottom: 1px solid rgba(0,0,0,0.05);
  }

  header {
    padding: 15px 20px 5px 20px;
    display: flex; justify-content: space-between; align-items: center;
  }

  h1 { font-size: 20px; font-weight: 700; margin: 0; color: var(--primary); letter-spacing: 0.5px; transition: color 0.5s;
  }

  /* Header å³ä¾§åŒºåŸŸå®¹å™¨ */
  .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
  }

  /* æ‹¼å›¾æŒ‰é”®æ ·å¼ä¸åŠ¨ç”» */
  .puzzle-btn {
      width: 28px; height: 28px;
      cursor: pointer;
      position: relative;
      display: flex; align-items: center; justify-content: center;
      color: var(--primary);
      transition: color 0.5s;
  }
  .puzzle-svg {
      width: 100%; height: 100%;
      fill: currentColor;
      animation: sway 3s ease-in-out infinite;
      transform-origin: center bottom;
  }
  .star-svg {
      position: absolute;
      top: 0px; right: 0px;
      width: 6px; height: 6px;
      fill: currentColor;
      animation: twinkle 3s ease-in-out 0.5s infinite; 
  }
  .star-white-mini {
      position: absolute;
      bottom: 2px;  
      left: 0px;
      width: 5px;
      height: 5px;
      fill: currentColor;
      z-index: 10;
      animation: twinkle 3s ease-in-out 1.5s infinite;
  }
  @keyframes sway {
      0%, 100% { transform: rotate(-5deg); }
      50% { transform: rotate(5deg); }
  }
  @keyframes twinkle {
      0%, 100% { opacity: 0.4; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
  }

  .sub-header { padding: 0 20px 5px 20px; position: relative; display: flex; align-items: center;
  }
  .control-row { display: flex; align-items: center; gap: 8px; width: 100%; }

  .custom-menu-wrap { position: relative; z-index: 110;
    flex-shrink: 0; }
  .custom-btn {
      display: flex; align-items: center; justify-content: center; gap: 4px;
      font-size: 13px; color: #888; background: rgba(255,255,255,0.6);
      height: 28px; width: 74px; border-radius: 6px; cursor: pointer; transition: all 0.2s; flex-shrink: 0;
  }
  .custom-btn:active, .custom-btn.active { background: #fff; color: var(--primary); }
 
  .custom-star-icon {
      width: 10px;
      height: 10px;
      fill: currentColor; 
      transition: transform 0.4s;
      display: inline-block;
      margin-top: -1px;
      margin-left: 2px;
  }
  .custom-btn.active .custom-star-icon {
      color: var(--primary);
  }

  #custom-dropdown {
      position: absolute; top: 35px; right: 0;
      left: auto; width: 180px; 
      background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
      border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.12);
      padding: 12px;
      display: none; flex-direction: column; gap: 10px; 
      border: 1px solid rgba(0,0,0,0.04);
  }
  .menu-row { display: flex; justify-content: space-between; align-items: center;
      font-size: 14px; color: #666; }
  .switch-wrap { display: flex; align-items: center; }
  .switch-input { display: none;
  }
  .switch-label {
    width: 22px; height: 13px; background: #ccc; border-radius: 10px;
    position: relative; cursor: pointer;
    transition: 0.3s; flex-shrink: 0; 
  }
  .switch-label::after {
    content: ''; position: absolute; top: 1.5px; left: 2px;
    width: 10px; height: 10px; background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  .switch-input:checked + .switch-label { background: var(--primary); }
  .switch-input:checked + .switch-label::after { transform: translateX(9px);
  }

  .header-input {
    background: transparent; border: none; outline: none;
    font-size: 13px; color: #aaa; flex: 1;
    border-bottom: 1px dashed transparent; transition: all 0.3s;
    font-family: -apple-system, "PingFang SC", sans-serif; padding-bottom: 2px; margin-right: 8px;
  }
  .header-input:focus, .header-input:not(:placeholder-shown) { border-bottom-color: var(--primary); color: var(--text-main); }
  .header-input::placeholder { color: #dcb; font-style: italic; opacity: 0.7;
  }

  .font-btn {
    width: 28px; height: 28px; background: rgba(255,255,255,0.6); border-radius: 6px;
    display: flex; align-items: center;
    justify-content: center;
    font-family: serif; font-style: italic; font-weight: bold;
    color: #888; cursor: pointer; font-size: 14px; flex-shrink: 0; margin-right: 8px;
  }
  .font-btn:active, .font-btn.active { background: #fff; color: var(--primary); }

  #font-dropdown {
    position: absolute; top: 50px;
    right: 20px; width: 200px; 
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
    border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.12);
    z-index: 200;
    max-height: 240px; overflow-y: auto; display: none; padding: 8px; border: 1px solid rgba(0,0,0,0.04);
  }
  .font-item {
    padding: 10px 12px; font-size: 16px; cursor: pointer; color: #666;
    border-radius: 8px; margin-bottom: 2px;
    display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;
  }
  .font-item:hover { background: #FCEEEE; color: var(--primary);
    padding-left: 16px;}
  .font-item.selected { background: var(--bg-top); color: var(--primary); font-weight: bold; }
  .font-item.selected::after { content: 'â—'; font-size: 8px;
    color: var(--primary); }

  .toggle-box {
    background: rgba(255,255,255,0.5); border-radius: 20px; padding: 3px;
    display: flex; font-size: 13px;
    cursor: pointer; flex-shrink: 0;
  }
  .toggle-item { padding: 6px 14px; border-radius: 18px; color: #999; transition: all 0.3s;
  }
  .toggle-item.active { background: #fff; color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  .toolbar {
    padding: 0 20px; display: flex; flex-direction: column; gap: 8px; margin-top: 5px; position: relative;
  }
  
  .slider-group {
      display: flex; align-items: center; gap: 10px; 
      background: rgba(255,255,255,0.4);
      padding: 6px 12px; border-radius: 16px; 
      width: 100%; box-sizing: border-box;
  }
  .slider-row {
      display: flex;
      align-items: center; gap: 6px;
      font-size: 12px; color: #999; flex: 1; min-width: 0; 
  }
  
  input[type=range] { -webkit-appearance: none;
    flex: 1; height: 4px; background: #ddd; border-radius: 2px; }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 14px;
    height: 14px;
    background: #fff; border: 2px solid var(--primary);
    border-radius: 50%; cursor: pointer; transition: transform 0.1s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .theme-palette { display: flex; gap: 8px; justify-content: center; align-items: center;
    padding: 4px 0;}
  .theme-dot {
    width: 16px; height: 16px; border-radius: 50%; border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; flex-shrink: 0;
  }

  /* ğŸŸ¢ æ–°å¢ï¼šèƒŒæ™¯æŒ‰é’®æ ·å¼ */
  .bg-btn {
      width: 20px; height: 20px; border-radius: 6px;
      background: #fff; border: 1px solid #ddd;
      color: #aaa; display: flex; align-items: center; justify-content: center;
      cursor: pointer; margin-left: 8px;
  }
  .bg-btn svg { width: 12px; height: 12px; fill: currentColor; }
  .bg-btn.active { border-color: var(--primary); color: var(--primary); }

/* ğŸŸ¢ æ–°å¢ï¼šèƒŒæ™¯ä¸‹æ‹‰èœå•æ ·å¼ (æ–°å¸ƒå±€) */
  #bg-dropdown {
      position: absolute; 
      top: -60px; /* ä½ç½®å‘ä¸Šè°ƒæ•´ */
      left: 20px; right: 20px;
      background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px);
      border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      padding: 12px;
      display: none; flex-direction: column; gap: 10px;
      border: 1px solid rgba(0,0,0,0.05);
      z-index: 300;
  }

  .bg-grid-row { display: flex; gap: 8px; width: 100%; } 
  
  .bg-option-box {
      flex: 1; height: 36px;
      border-radius: 8px; border: 1px dashed #ddd;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: #ccc; transition: all 0.2s; background: #fafafa;
  }
  .bg-option-box:hover { border-color: var(--primary); color: var(--primary); background: #fff; }
  .bg-option-box svg { width: 16px; height: 16px; fill: currentColor; }
  
  .bg-slider-row { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #999; }
  .bg-label { width: 4em; text-align: right; white-space: nowrap;}

  /* ğŸŸ¢ æ–°å¢ï¼šç´§å‡‘å‹åŒæ»‘è½¨è¡Œæ ·å¼ */
  .bg-slider-row.compact {
      justify-content: space-between;
      gap: 15px; /* ä¸¤ä¸ªæ»‘è½¨ç»„ä¹‹é—´çš„é—´è· */
  }
  .bg-slider-unit {
      display: flex; align-items: center; gap: 6px; 
      flex: 1; min-width: 0; /* é˜²æ­¢æº¢å‡º */
  }
  .bg-label-s {
      font-size: 11px; color: #999; flex-shrink: 0; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
  }

  .bottom-bar {
      position: relative; 
      width: 100%;
      flex-shrink: 0; 
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-top: 1px solid rgba(0,0,0,0.06);
      padding: 8px 15px; 
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
      display: flex; align-items: center; justify-content: flex-start; gap: 8px;
      z-index: 400;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
  }

  .btn-row { display: flex; align-items: center; gap: 4px; flex-shrink: 0;
  }
  .icon-btn {
    width: 30px; height: 30px; 
    border-radius: 6px; border: none;
    background: #f2f2f2; color: #777;
    font-size: 13px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    padding: 0; transition: all 0.2s;
  }
  .icon-btn:active { transform: scale(0.9); background: #e0e0e0; }
  .icon-btn svg { width: 14px; height: 14px; stroke: #777;
    stroke-width: 2.5; }
  .icon-btn.btn-active { background: var(--primary); color: #fff; }
  .icon-btn.btn-active svg { stroke: #fff;
  }

  .marker-palette {
    display: flex; align-items: center; gap: 5px; 
    background: transparent; 
    padding: 0; 
    margin-left: 5px;
    border-left: 1px solid #eee; padding-left: 8px;
    flex: 1; overflow-x: auto; 
  }
  .marker-palette::-webkit-scrollbar { display: none;
  } 
  
  .marker-icon { font-size: 13px; margin-right: 0; color:#aaa;
    flex-shrink: 0;} 
  .color-dot {
    width: 16px; height: 16px; 
    border-radius: 50%; cursor: pointer; flex-shrink: 0;
    border: 2px solid rgba(0,0,0,0.05); transition: transform 0.2s;
  }
  .color-dot.clear::after { width: 8px; height: 2px;
  }

  /* æ ·å¼ç±» */
  [class^="hl-"] {
    background-color: var(--hl-bg); -webkit-box-decoration-break: clone; box-decoration-break: clone;
    border-radius: 0;
    padding: 2px 0; margin: 0 -1px; 
  }
  .text-big { font-size: 1.4em; line-height: 1.2;
  }
  
  /* ğŸŸ¢ ä¿®å¤ï¼šMarkdown ä»£ç å—æ ·å¼ï¼Œå»æ‰å¤§æ¡†å’ŒèƒŒæ™¯ï¼Œä¿ç•™é¢œè‰²åŠ ç²— */
  code {
      background: transparent;   
      color: var(--primary);     
      padding: 0 2px;            
      border-radius: 0;          
      font-family: inherit;      
      font-size: 0.9em;          
      font-weight: bold;         
      border: none;              
      transition: all 0.5s;
  }
  
  hr.theme-hr {
      border: 0;
      border-top: 1px solid #e0e0e0; 
      margin: 20px 0;
      transition: border-color 0.5s;
  }

  .hl-pink { --hl-bg: rgba(255, 216, 228, 0.7); } .hl-green { --hl-bg: rgba(208, 240, 192, 0.7);
  } .hl-purple { --hl-bg: rgba(242, 227, 248, 0.7); } .hl-blue { --hl-bg: rgba(204, 242, 255, 0.7);
  } .hl-yellow { --hl-bg: rgba(255, 250, 205, 0.7); } .hl-gray { --hl-bg: rgba(232, 232, 232, 0.7);
  }

  .viewport {
    flex: 1; 
    overflow-y: auto; 
    padding: 25px; 
    font-size: 16px; scroll-behavior: smooth; 
    /* èƒŒæ™¯è‰²æ”¹ä¸ºé€æ˜ï¼Œä»¥ä¾¿æ˜¾ç¤ºåº•å±‚èƒŒæ™¯ */
    background: transparent; 
    padding-bottom: 25px; 
    position: relative;
    z-index: 2; /* ä¿è¯å†…å®¹åœ¨èƒŒæ™¯ä¹‹ä¸Š */
  }

  .viewport h1, .viewport h2, .viewport h3 {
      margin: 10px 0 5px 0;
      font-weight: bold;
      color: var(--primary); 
      line-height: 1.4;
  }

  .viewport h4 { 
      font-size: 1em;
      font-weight: 900; 
      color: #333333;
      margin: 1.5em 0 0.5em 0;
      opacity: 1; 
  }
  .viewport h1 { font-size: 1.4em;
    border-bottom: 2px solid var(--bg-top); padding-bottom: 5px; }
  .viewport h2 { font-size: 1.2em; }
  .viewport h3 { font-size: 1.1em;
    opacity: 0.9; }

  /* FAB ç»„ä½ç½® */
  .fab-group {
    position: absolute; 
    bottom: 55px; 
    right: 25px; 
    display: flex; flex-direction: column;
    align-items: flex-end; /* å³å¯¹é½ */
    gap: 15px; z-index: 200;
  }
  /* å¯¼å‡ºé”®å’Œ End é”®çš„è¡Œå®¹å™¨ */
  .fab-row {
      display: flex; align-items: center; gap: 15px;
  }
  
  #tip-box {
      position: absolute; 
      bottom: 55px; left: 20px;
      z-index: 150; max-width: 220px;
      height: auto; 
      display: flex; flex-direction: column; justify-content: flex-end;
      font-size: 11px; color: rgba(0,0,0,0.25); font-style: italic; line-height: 1.5; pointer-events: none; user-select: none;
  }

  /* å…¶ä»–å¿…è¦æ ·å¼ */
  #paper-header { width: 100%; margin-bottom: 25px; color: var(--primary); transition: color 0.5s; display: none;
    font-family: var(--header-font); flex-direction: row; align-items: stretch; justify-content: flex-start; gap: 15px; }
  #header-img-wrap { position: relative; display: none; flex-shrink: 0;
    margin-right: 10px; }
  #header-img-preview { width: 0; min-width: 0; border-radius: 6px; background-size: cover; background-position: center; background-repeat: no-repeat; cursor: pointer;
    border: 1.5px dashed #e0e0e0; transition: opacity 0.2s, background-image 0.3s; }
  body.printing #header-img-preview { border: none !important;
  }
  #btn-img-gear { position: absolute; top: 0; right: -28px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
    font-size: 14px; cursor: pointer; opacity: 0.3; transition: opacity 0.3s, transform 0.5s; z-index: 60; }
  #btn-img-gear:hover { opacity: 1;
    transform: rotate(90deg); }
  body.printing #btn-img-gear { display: none !important; }
  #img-toolbar { position: absolute; top: 30px; left: 0;
    background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px; padding: 10px; width: 170px;
    display: none; z-index: 200; flex-direction: column; gap: 10px; }
  body.printing #img-toolbar { display: none !important;
  }
  .img-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 11px; color: #888;
  }
  .img-row.presets { justify-content: space-around; margin-top: 4px; }
  .preset-img { width: 32px; height: 32px; border-radius: 6px; background-size: 80%;
    background-position: center; background-repeat:no-repeat; cursor: pointer; border: 1px solid #eee; background-color: #fff; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .img-color-row { display: flex; justify-content: space-evenly; width: 100%; margin-top: 5px;
  }
  .img-color-dot { width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.05);
  }
  .img-slider { -webkit-appearance: none; height: 4px; background: #eee; border-radius: 2px; flex: 1; width: 100%;
  }
  .header-text-col { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; margin-left: auto; flex-shrink: 0; min-height: 1.5em; height: fit-content;
    align-self: center; }
  .preview-note { font-weight: 400; opacity: 1; display: block; line-height: 1.2; text-align: right; white-space: nowrap;
  }
  .preview-date { font-weight: 400; opacity: 1; display: block; margin-top: 4px; font-family: inherit; color: inherit; text-align: right; white-space: nowrap;
  }
  #title-container { position: relative; width: 100%; margin-bottom: 10px; display: none; }
  #title-box-wrap { width: 100%; box-sizing: border-box;
    border: 1.5px dashed #ddd; border-radius: 8px; padding: 10px 30px 10px 10px; text-align: center; font-weight: bold; color: var(--text-main); outline: none;
    transition: all 0.3s; }
  #title-box-wrap:empty:before { content: 'ç‚¹å‡»è¾“å…¥æ ‡é¢˜'; color: #ccc; font-weight: normal; font-size: 0.6em;
  }
  body.printing #title-box-wrap { border: none !important; padding: 10px 0; }
  #btn-title-gear { position: absolute; top: 5px;
    right: 5px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; opacity: 0.4;
    transition: opacity 0.3s, transform 0.5s; z-index: 10; }
  #btn-title-gear:hover { opacity: 1; transform: rotate(90deg);
  }
  body.printing #btn-title-gear { display: none !important; }
  #title-toolbar { display: none; margin-top: 5px; margin-bottom: 20px; background: rgba(255,255,255,0.9);
    border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 12px; padding: 10px; flex-direction: column; width: 100%; box-sizing: border-box;
    position: relative; z-index: 50; animation: slideDown 0.3s ease-out; }
  @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1;
    transform:translateY(0);} }
  body.printing #title-toolbar, body.printing #title-font-menu { display: none !important; }
  .tt-row { display: flex; align-items: center;
    gap: 8px; justify-content: center; width: 100%; }
  .tt-btn { width: 28px; height: 28px; border-radius: 6px; background: #f2f2f2; color: #666;
    display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; cursor: pointer; font-family: serif; transition: all 0.2s;
  }
  .tt-btn.active { background: var(--primary); color: #fff; }
  .font-family-btn { width: auto; padding: 0 8px; font-family: sans-serif;
    font-size: 11px; gap: 4px; }
  .tt-arrow { font-size: 8px; opacity: 0.6; }
  .tt-divider { width: 1px; height: 16px;
    background: #eee; }
  .tt-slider { -webkit-appearance: none; height: 4px; background: #eee; border-radius: 2px; flex: 1;
  }
  .tt-color-dot { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.05); transition: transform 0.2s;
    flex-shrink: 0; }
  .tt-custom-wrap { flex: 1; display: flex; flex-direction: column; gap: 8px; margin-left: 8px; background: #fafafa;
    padding: 8px 10px; border-radius: 8px; border: 1px solid #eee; }
  .tt-slider-row { display: flex; align-items: center; gap: 8px;
    font-size: 10px; color: #aaa; }
  .tt-hue-slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 4px;
    background: linear-gradient(to right, #FF0000, #FFFF00, #00FF00, #00FFFF, #0000FF, #FF00FF, #FF0000); opacity: 0.9; }
  .tt-sat-slider { -webkit-appearance: none; width: 100%;
    height: 6px; border-radius: 4px; background: #eee; opacity: 0.9; }
  .tt-light-slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 4px;
    background: #eee; opacity: 0.9; }
  #title-font-menu { position: absolute; top: 45px; left: 10px; background: rgba(255,255,255,0.98); border: 1px solid #eee;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-radius: 8px; padding: 5px; max-height: 200px; overflow-y: auto; display: none; z-index: 100; width: 140px;
  }
  .tt-font-item { padding: 8px; font-size: 14px; color: #666; cursor: pointer; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .tt-font-item:hover { background: #f9f9f9; color: var(--primary); }
  #mode-note { min-height: 50vh; outline: none; line-height: 1.8; color: var(--text-main);
    white-space: pre-wrap; }
  #mode-note:empty:before { content: 'âœ¨ éšæ‰‹è®°ç‚¹ä»€ä¹ˆ...'; color: #ddd; }
  #mode-chat { display: none; flex-direction: column;
    padding-bottom: 25px; }
  .bubble-wrap { display: flex; margin-bottom: 15px; position: relative; width: 100%;
  }
  .bubble { padding: 12px 16px; font-size: inherit; line-height: 1.6; outline: none; word-break: break-all; position: relative; transition: background 0.5s;
  }
  .bubble-wrap.left { justify-content: flex-start; }
  .left .bubble { background: transparent; border-bottom: 2px dashed #eee; color: var(--text-main);
    width: 95%; padding-left: 0; border-radius: 0; }
  .left .bubble:focus { border-bottom-color: var(--primary);
  }
  .left .bubble.empty-state { color: #bbb !important; font-style: italic !important; }
  .bubble-wrap.right { justify-content: flex-end;
  }
  /* ğŸŸ¢ ä¿®æ”¹ï¼šæ°”æ³¡æ ·å¼æ”¯æŒé€æ˜åº¦å’Œæ¨¡ç³Š */
  .right .bubble { 
      background: rgba(var(--bubble-rgb), var(--bubble-op)); 
      backdrop-filter: blur(var(--bubble-blur));
      -webkit-backdrop-filter: blur(var(--bubble-blur));
      border-radius: 18px 18px 2px 18px; 
      color: var(--text-bubble-r); 
      max-width: 80%;
  }
  .right .bubble:empty { min-height: 1em; min-width: 2em; }
  .del-btn { position: absolute; width: 20px; height: 20px;
    background: #f0f0f0; color: #aaa; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; z-index: 5;
  }
  .left .del-btn { left: -22px; top: 12px; }
  .right .del-btn { right: -8px; top: -8px; background: var(--primary);
    color: #fff;}
  .add-btn { text-align: center; padding: 15px; border: 2px dashed #f0f0f0; border-radius: 12px; color: #ccc; font-size: 13px;
    cursor: pointer; margin-top: 10px; }
  .add-btn:hover { border-color: var(--primary); color: var(--primary); }
  .tip-close { position: absolute; top: -18px;
    left: 0; cursor: pointer; font-size: 16px; color: rgba(0,0,0,0.2); pointer-events: auto; width: 20px; height: 20px; transition: color 0.3s;
  }
  .tip-close:hover { color: var(--primary); }
  
  /* FAB æ ·å¼ */
  .mini-fab { width: 40px; height: 40px; background: #fff; border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; color: #888; font-size: 12px; cursor: pointer; font-weight: bold;
    flex-shrink: 0; /* é˜²æ­¢æŒ¤å‹ */
  }
  /* å¯¼å‡ºé”®è™½ç„¶ç”¨äº† mini-fab å°ºå¯¸ï¼Œä½†ä¹ŸåŠ ä¸Šé¢œè‰²è¿‡æ¸¡ */
  .mini-fab svg { transition: stroke 0.5s; }

  @media(min-width: 500px) { .fab-group { right: calc(50% - 240px); } }
  #modal { display: none; position: fixed;
    top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.98); z-index: 999; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto;
  }
  #modal img { max-width: 85%; max-height: 65%; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #eee; pointer-events: auto;
    -webkit-user-select: none; user-select: none; -webkit-touch-callout: default; }
  .save-tip { margin-top: 15px; color: #999; font-size: 14px; letter-spacing: 1px; font-weight: 500;
    animation: fadeIn 1s; }
  @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
  
  /* å¼¹çª—æŒ‰é’®å¸ƒå±€ */
  .modal-actions { display: flex; flex-direction: column; gap: 10px; align-items: center;
    margin-top: 25px; width: 80%; max-width: 300px; }
  .btn-modal { padding: 10px 35px; border-radius: 30px; border: none; font-size: 14px; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; transition: transform 0.1s; }
  .btn-modal:active { transform: scale(0.98); }
  .btn-cancel { background: #f5f5f5; color: #555; }
  .btn-primary { background: var(--primary); color: #fff; }

  #lib-modal { display: none;
    position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.98); z-index: 998; flex-direction: column; padding: 20px; padding-top: env(safe-area-inset-top);
    animation: fadeIn 0.3s; }
  .lib-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px;
    border-bottom: 1px solid #eee; }
  /* è®°å¿†åº“æ ‡é¢˜æ”¹ç”¨ç³»ç»Ÿå­—ä½“ */
  .lib-title { font-size: 20px; font-weight: bold; color: var(--primary); font-family: -apple-system, "PingFang SC", sans-serif;
  }
  .lib-close { font-size: 24px; color: #ccc; cursor: pointer; }
  .lib-list { flex: 1; overflow-y: auto; display: flex;
    flex-direction: column; gap: 15px; }
  .lib-item { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 15px; display: flex;
    justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: all 0.2s; }
  .lib-item:active { transform: scale(0.98); border-color: var(--primary);
  }
  .lib-info { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 0;}
  .lib-name { font-weight: bold; color: #555;
    font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
  .lib-date { font-size: 12px; color: #aaa; display: flex; align-items: center; gap: 8px;}
  /* æ‘˜è¦é¢„è§ˆæ ·å¼ */
  .lib-preview { font-size: 12px; color: #999; margin-top: 4px; line-height: 1.4;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; opacity: 0.8; }
  
  .lib-del { padding: 8px 12px; background: #fff0f0;
    color: #ff6b6b; border-radius: 8px; font-size: 12px; cursor: pointer; margin-left: 10px; flex-shrink: 0; }
  #toast { position: fixed; bottom: 100px; left: 50%;
    transform: translateX(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 1000; opacity: 0; pointer-events: none;
    transition: opacity 0.3s; }
  #toast.show { opacity: 1; }

  /* ================= ç™½è‰²æ–‡å­—æ¨¡å¼ ================= */
  body.white-text-mode {
      --text-main: #ffffff;
      --text-bubble-r: #ffffff;
  }
  
  /* å¼ºåˆ¶å˜ç™½çš„å…ƒç´ é›†åˆ */
  
  body.white-text-mode .preview-note,
  body.white-text-mode .preview-date,
  body.white-text-mode #title-box-wrap,
  body.white-text-mode #mode-note,
  body.white-text-mode .bubble
  {
      color: #ffffff !important;
  }

  /* è¾“å…¥æ¡†å ä½ç¬¦å˜åŠé€æ˜ç™½ */
  body.white-text-mode .header-input::placeholder {
      color: rgba(255,255,255,0.6) !important;
  }
  
  /* é’ˆå¯¹å¯¼å‡ºå›¾ç‰‡æ—¶çš„å­—æ•°ç»Ÿè®¡ */
  body.white-text-mode .export-footer-text {
      color: #ffffff !important;
  }
/* ğŸš‘ ç´§æ€¥ä¿®å¤ï¼šå¼ºåˆ¶é¡¶éƒ¨è¾“å…¥æ¡†åœ¨ç™½è‰²æ¨¡å¼ä¸‹ä¿æŒæ·±ç°ï¼Œä¸è®¸å˜ç™½ */
body.white-text-mode #header-note {
    color: #5A5A5A !important;
}
</style>
</head>
<body>

<div id="app-container">
  <div id="bg-layer"></div>
  <div id="bg-mask"></div>
  
  <div class="top-area">
    <header>
      <h1>Mochi Script</h1>
      <div class="header-right">
     <div class="puzzle-btn" onclick="openLibrary()">
    <svg id="puzzle-icon" class="puzzle-svg" viewBox="0 0 20000 20000">
        </svg>
    
    <svg class="star-svg" viewBox="0 0 24 24">
        <path d="M12,2 C12.8,2, 13.5,2.5, 13.8,3.2 L15.4,7.8 C15.7,8.5, 16.3,9.1, 17.1,9.4 L21.7,11.0 C22.4,11.3, 22.9,12.0, 22.9,12.8 C22.9,13.6, 22.4,14.3, 21.7,14.5 L17.1,16.2 C16.3,16.5, 15.7,17.1, 15.4,17.8 L13.8,22.4 
          C13.5,23.1, 12.8,23.6, 12,23.6 C11.2,23.6, 10.5,23.1, 10.2,22.4 L8.6,17.8 C8.3,17.1, 7.7,16.5, 6.9,16.2 L2.3,14.5 C1.6,14.3, 1.1,13.6, 1.1,12.8 C1.1,12.0, 1.6,11.3, 2.3,11.0 L6.9,9.4 C7.7,9.1, 8.3,8.5, 8.6,7.8 L10.2,3.2 C10.5,2.5, 11.2,2, 12,2 Z"/>
    </svg>

    <svg class="star-white-mini" viewBox="0 0 24 24">
        <path d="M12,2 C12.8,2, 13.5,2.5, 13.8,3.2 L15.4,7.8 C15.7,8.5, 16.3,9.1, 17.1,9.4 L21.7,11.0 C22.4,11.3, 22.9,12.0, 22.9,12.8 C22.9,13.6, 22.4,14.3, 21.7,14.5 L17.1,16.2 C16.3,16.5, 15.7,17.1, 15.4,17.8 L13.8,22.4 C13.5,23.1, 12.8,23.6, 12,23.6 C11.2,23.6, 10.5,23.1, 10.2,22.4 L8.6,17.8 C8.3,17.1, 7.7,16.5, 6.9,16.2 L2.3,14.5 C1.6,14.3, 1.1,13.6, 1.1,12.8 C1.1,12.0, 1.6,11.3, 2.3,11.0 L6.9,9.4 C7.7,9.1, 8.3,8.5, 8.6,7.8 L10.2,3.2 C10.5,2.5, 11.2,2, 12,2 Z"/>
    </svg>
</div>
    
          <div class="toggle-box">
              <div class="toggle-item active" id="tab-note" onclick="mode('note')">éšè®°</div>
              <div class="toggle-item" id="tab-chat" onclick="mode('chat')">å‰§åœº</div>
          </div>
      </div>
    </header>

<div class="sub-header">
        <div class="control-row">
            <input type="text" class="header-input" id="header-note" 
                   placeholder="è¾“å…¥æ ‡æ³¨â€¦â€¦" oninput="updateHeaderPreview()">
            
            <div class="font-btn" id="font-btn" onclick="toggleFontMenu()">Aa</div>

            <div class="custom-menu-wrap">
                <div class="custom-btn" onclick="toggleCustomMenu(event)">
                    <span>è‡ªå®šä¹‰</span>
                    <svg class="custom-star-icon" viewBox="0 0 24 24">
                        <path d="M12,2 C12.8,2, 13.5,2.5, 13.8,3.2 L15.4,7.8 C15.7,8.5, 16.3,9.1, 17.1,9.4 L21.7,11.0 C22.4,11.3, 22.9,12.0, 22.9,12.8 C22.9,13.6, 22.4,14.3, 21.7,14.5 L17.1,16.2 C16.3,16.5, 15.7,17.1, 15.4,17.8 L13.8,22.4 C13.5,23.1, 12.8,23.6, 12,23.6 C11.2,23.6, 10.5,23.1, 10.2,22.4 L8.6,17.8 C8.3,17.1, 7.7,16.5, 6.9,16.2 L2.3,14.5 C1.6,14.3, 1.1,13.6, 1.1,12.8 C1.1,12.0, 1.6,11.3, 2.3,11.0 L6.9,9.4 C7.7,9.1, 8.3,8.5, 8.6,7.8 L10.2,3.2 C10.5,2.5, 11.2,2, 12,2 Z"/>
                    </svg>
                </div>
      
                <div id="custom-dropdown">
                    <div class="menu-row">
                        <span>å­—æ•°ç»Ÿè®¡</span>
                        <div class="switch-wrap">
                             <input type="checkbox" id="count-switch" class="switch-input" checked onchange="saveCountState()">
                            <label for="count-switch" class="switch-label"></label>
                        </div>
                    </div>
            
                    <div class="menu-row">
                        <span>æ˜¾ç¤ºæ—¥æœŸ</span>
                        <div class="switch-wrap">
                            <input type="checkbox" id="date-switch" class="switch-input" onchange="updateHeaderPreview()">
                            <label for="date-switch" class="switch-label"></label>
                        </div>
                    </div>
                    <div class="menu-row">
                         <span>Logo</span>
                        <div class="switch-wrap">
                            <input type="checkbox" id="logo-switch" class="switch-input" onchange="toggleLogo(this.checked)">
                            <label for="logo-switch" class="switch-label"></label>
                         </div>
                    </div>
                    <div class="menu-row">
                        <span>æ ‡é¢˜</span>
                        <div class="switch-wrap">
                            <input type="checkbox" id="title-switch" class="switch-input" onchange="toggleTitle(this.checked)">
                            <label for="title-switch" class="switch-label"></label>
                        </div>
                     </div>
                    <div class="menu-row">
                        <span>Markdown</span>
                        <div class="switch-wrap">
                             <input type="checkbox" id="md-switch" class="switch-input" checked onchange="toggleMarkdown(this.checked)">
                            <label for="md-switch" class="switch-label"></label>
                        </div>
                    </div>
                    <div class="menu-row">
                        <span>è½¬ç™½è‰²æ–‡å­—</span>
                        <div class="switch-wrap">
                             <input type="checkbox" id="white-text-switch" class="switch-input" onchange="toggleWhiteTextMode(this.checked)">
                            <label for="white-text-switch" class="switch-label"></label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="font-dropdown"></div>
        <input type="file" id="h-img-input" accept="image/*" style="display:none" onchange="handleImgChange(this)">
    </div>

    <div class="toolbar">
      <div class="slider-group">
          <div class="slider-row">
              <span style="font-size:10px; opacity:0.5; width:15px; text-align:center">T</span>
              <input type="range" id="range-header" min="14" max="36" value="18" oninput="setHeaderFont(this.value)">
          </div>
          <div style="width:1px; height:16px; background:#ddd;"></div> 
          <div class="slider-row">
              <span style="font-size:10px; opacity:0.5; width:15px; text-align:center">A</span>
              <input type="range" id="range-body" min="12" max="24" value="16" oninput="setBodyFont(this.value)">
          </div>
      </div>
      
      <div class="theme-palette">
          <div class="theme-dot" style="background:#E69A8D;" onclick="theme('#E69A8D', '#F9F3F3', '#FBE3E1', '#FCEEEE', '251,227,225')"></div>
          <div class="theme-dot" style="background:#e4c5d4;" onclick="theme('#e4c5d4', '#FCF6F9', '#F6E4EC', '#FDF2F7', '246,228,236')"></div>
          <div class="theme-dot" style="background:#92B4A7;" onclick="theme('#92B4A7', '#F4F8F6', '#E0ECE7', '#EAF2EE', '224,236,231')"></div>
          <div class="theme-dot" style="background:#BCA0BC;" onclick="theme('#BCA0BC', '#F7F4F7', '#E8DEE8', '#F1ECF1', '232,222,232')"></div>
          <div class="theme-dot" style="background:#9ABCCA;" onclick="theme('#9ABCCA', '#F3F7F9', '#E1ECF1', '#EBF2F5', '225,236,241')"></div>
          <div class="theme-dot" style="background:#F0C058;" onclick="theme('#F0C058', '#FEFBF0', '#FDF5D8', '#FEF9E6', '253,245,216')"></div>
          
          <div class="theme-dot" style="background:#F2F3F5;" onclick="theme('#A0A0A0', '#F2F3F5', '#FFFFFF', '#FFFFFF', '255,255,255')" title="ç™½æ°”æ³¡ä¸»é¢˜"></div>

          <div class="theme-dot" style="background:#555555;" onclick="theme('#555555', '#F5F5F5', '#555555', '#EDEDED', '85,85,85')"></div>
          
          <div class="bg-btn" id="bg-btn" onclick="toggleBgMenu(event)">
              <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-5.04-6.71l-2.75 3.54-1.96-2.36L6.5 17h11l-3.54-4.71z"/></svg>
          </div>
      </div>

<div id="bg-dropdown">
          <div class="bg-grid-row">
              <div class="bg-option-box" onclick="setBgPattern('none')" title="æ— èƒŒæ™¯">
                  <svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </div>
              <div class="bg-option-box" onclick="triggerBgUpload()" title="ä¸Šä¼ å›¾ç‰‡">
                  <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
              </div>
              <div class="bg-option-box" onclick="setBgPattern('dot')" title="æ³¢ç‚¹">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="6"/></svg>
              </div>
              <div class="bg-option-box" onclick="setBgPattern('grid')" title="æ–¹æ ¼">
                  <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zm10 0h8v8h-8zM3 13h8v8H3zm10 0h8v8h-8z"/></svg>
              </div>
              <input type="file" id="bg-img-input" accept="image/*" style="display:none" onchange="handleBgUpload(this)">
          </div>
          <div class="bg-slider-row compact" style="margin-top:5px;">
              <div class="bg-slider-unit">
                  <div class="bg-label-s">æ°”æ³¡æµ“åº¦</div>
                  <input type="range" class="img-slider" id="bubble-op-slider" min="0" max="100" value="100" oninput="setBubbleOpacity(this.value)">
              </div>
              <div class="bg-slider-unit">
                  <div class="bg-label-s">èƒŒæ™¯æµ“åº¦</div>
                  <input type="range" class="img-slider" id="bg-op-slider" min="0" max="100" value="30" oninput="setBackgroundOpacity(this.value)">
              </div>
          </div>
      </div>

    </div>
  </div>
<div class="viewport" id="viewport">
    
    <div id="paper-header">
        <div id="header-img-wrap">
             <div id="header-img-preview" onclick="triggerImgUpload()"></div>
            <div id="btn-img-gear" onclick="toggleImgToolbar(event)">
                 <svg width="100%" height="100%" viewBox="0 0 24 24" fill="currentColor" style="color:#aaa;"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </div>
            <div id="img-toolbar">
               <div class="img-row">
                   <span>Opacity</span>
                   <input type="range" class="img-slider" min="0" max="100" value="100" oninput="setImgOpacity(this.value)">
               </div>
               <div class="img-row presets">
                   <div class="preset-img" id="btn-gpt" onclick="setPresetImg('gpt')" title="GPT"></div>
                    <div class="preset-img" id="btn-gemini" onclick="setPresetImg('gemini')" title="Gemini"></div>
                    <div class="preset-img" id="btn-claude" onclick="setPresetImg('claude')" title="Claude"></div>
               </div>
               <div class="img-color-row">
                   <div class="img-color-dot" style="background:linear-gradient(135deg, #eee 0%, #aaa 100%);" onclick="setImgColorMode('original')" title="åŸè‰²"></div>
                   <div class="img-color-dot" style="background:#333;" onclick="setImgColorMode('black')" title="é»‘è‰²"></div>
                   <div class="img-color-dot" style="background:var(--primary);" onclick="setImgColorMode('theme')" title="ä¸»é¢˜è‰²"></div>
                   <div class="img-color-dot" style="background:var(--bubble-R);" onclick="setImgColorMode('bubble')" title="æ°”æ³¡è‰²"></div>
                </div>
            </div>
        </div>
        
        <div class="header-text-col">
            <span class="preview-note" id="p-note"></span>
            <span class="preview-date" id="p-date"></span>
        </div>
    </div>

    <div id="title-container">
        <div id="btn-title-gear" onclick="toggleTitleToolbarPanel()">
            <svg width="100%" height="100%" viewBox="0 0 24 24" fill="currentColor" style="color:#888;"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
        </div>
        <div id="title-box-wrap" contenteditable="true" oninput="saveTitleText()"></div>
    </div>
    
    <div id="title-toolbar">
        <div class="tt-row">
            <div class="tt-btn font-family-btn" onclick="toggleTitleFontMenu(event)">Aa <span class="tt-arrow">â–¼</span></div>
            <div class="tt-divider"></div>
            <div class="tt-btn" id="tt-bold" onclick="toggleTitleStyle('bold')">B</div>
            <div class="tt-btn" id="tt-italic" onclick="toggleTitleStyle('italic')">I</div>
            <div class="tt-divider"></div>
            <span style="font-size:10px; color:#aaa;">T</span>
            <input type="range" class="tt-slider" id="tt-size-slider" min="10" max="48" step="1" oninput="setTitleSize(this.value)">
        </div>

        <div class="tt-row" style="margin-top:8px; align-items:flex-start;">
            <div style="display:flex; gap:6px; margin-top:10px;">
                <div class="tt-color-dot" style="background:#333" onclick="setTitleColor('black')" title="é»˜è®¤é»‘"></div>
                <div class="tt-color-dot" style="background:var(--primary)" onclick="setTitleColor('theme')" title="è·Ÿéšä¸»é¢˜"></div>
                <div class="tt-color-dot" style="background:var(--bubble-R)" onclick="setTitleColor('bubble')" title="è·Ÿéšæ°”æ³¡"></div>
            </div>
            
            <div class="tt-custom-wrap">
                 <div class="tt-slider-row">
                    <span>H</span>
                    <input type="range" class="tt-hue-slider tt-color-thumb" id="tt-hue" min="0" max="360" oninput="setTitleColor('customHue', this.value)">
                </div>
                <div class="tt-slider-row">
                     <span>S</span>
                    <input type="range" class="tt-sat-slider tt-color-thumb" id="tt-sat" min="0" max="100" oninput="setTitleColor('customSat', this.value)">
                </div>
                <div class="tt-slider-row">
                    <span>L</span>
                     <input type="range" class="tt-light-slider tt-color-thumb" id="tt-light" min="0" max="100" oninput="setTitleColor('customLight', this.value)">
                </div>
            </div>
        </div>

        <div id="title-font-menu"></div>
    </div>

    <div id="mode-note" contenteditable="true" onblur="autoMagic(this)"></div>
    <div id="mode-chat">
        <div id="chat-stream"></div>
      <div class="add-btn" onclick="add()">+ æ·»åŠ å¯¹è¯è¡Œ</div>
    </div>
  </div>

  <div id="tip-box">
      <div class="tip-close" onclick="this.parentElement.style.display='none'">Ã—</div>
      <div class="tip-content">
          1. è§å…‰ç¬”éœ€åˆ†è¡Œæ¶‚æŠ¹ï¼Œæ¶‚å®Œä¸€è¡Œæ¶‚ä¸€è¡Œâ€¦<br>
          2. å–æ¶ˆä»¥ä¸‹æ•ˆæœâ†“éœ€å…‰æ ‡ç‚¹å…¥æ–‡å­—ï¼Œæ— éœ€å…¨é€‰
      </div>
  </div>

  <div class="fab-group">
      <div class="mini-fab" onclick="toTop()">TOP</div>
      <div class="fab-row">
          <div class="mini-fab" onclick="exportImg()">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div class="mini-fab" onclick="toBottom()">END</div>
      </div>
  </div>

  <div class="bottom-bar">
      <div class="btn-row">
          <button class="icon-btn" onclick="toggleBold()"><b>B</b></button>
          <button class="icon-btn" onclick="toggleItalic()"><i>I</i></button>
          <button class="icon-btn" onclick="toggleCenter()">
              <svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18M7 12h10M3 18h18" stroke-width="2" stroke-linecap="round" 
 /></svg>
          </button>
          <button class="icon-btn" onclick="toggleBig()" style="font-weight:900; font-size:13px;">å¤§</button>
      </div>
      
      <div class="marker-palette">
          <span class="marker-icon">ğŸ–Š</span>
          <div class="color-dot" style="background:rgba(255, 216, 228, 0.6)" onmousedown="event.preventDefault()" onclick="setMarker('hl-pink')"></div>
          <div class="color-dot" style="background:rgba(208, 240, 192, 0.6)" onmousedown="event.preventDefault()" onclick="setMarker('hl-green')"></div>
          <div class="color-dot" style="background:rgba(242, 227, 248, 0.6)" onmousedown="event.preventDefault()" onclick="setMarker('hl-purple')"></div>
          <div class="color-dot" style="background:rgba(204, 242, 255, 0.6)" onmousedown="event.preventDefault()" onclick="setMarker('hl-blue')"></div>
          <div class="color-dot" style="background:rgba(255, 250, 205, 0.6)" onmousedown="event.preventDefault()" onclick="setMarker('hl-yellow')"></div>
          <div class="color-dot" style="background:#E8E8E8" onmousedown="event.preventDefault()" onclick="setMarker('hl-gray')"></div>
          <div class="color-dot clear" title="æ¸…é™¤" onmousedown="event.preventDefault()" onclick="setMarker('clear')"></div>
      </div>
  </div>

</div>

<div id="modal">
    <img id="res-img" src="">
    <div class="save-tip">é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡å¯ä¿å­˜åˆ°ç›¸å†Œ</div>
    <div class="modal-actions">
        <button class="btn-modal btn-primary" onclick="saveCurrentNote()">ä¿å­˜è‡³è®°å¿†åº“</button>
        <button class="btn-modal btn-cancel" onclick="document.getElementById('modal').style.display='none'">å…³é—­ / ç»§ç»­ç¼–è¾‘</button>
    </div>
</div>

<div id="lib-modal">
    <div class="lib-header">
        <div class="lib-title">è®°å¿†åº“ Â· Archives</div>
        <div class="lib-close" onclick="closeLibrary()">Ã—</div>
    </div>
    
    <button class="btn-modal" style="background:var(--primary); color:#fff; width:100%; margin-bottom:15px;" onclick="saveCurrentNote()">+ ä¿å­˜å½“å‰è®°å½•</button>
    
    <div class="lib-list" id="lib-list">
        </div>
</div>

<div id="toast">å·²ä¿å­˜</div>
<script>
    let curMode = 'note';
    let turn = 0; 
    const DEFAULT_TXT = "è¯·è¾“å…¥â€¦â€¦";
    let isMagicOn = true; 
    
    // é»˜è®¤é¢œè‰²
    let currentThemeHex = '#E69A8D';
    let currentBubbleHex = '#FBE3E1';
    
    let imgConfig = {
        opacity: 100,
        colorMode: 'original', 
        activeLogo: null 
    };
    
   // ğŸŸ¢ æ–°å¢ï¼šèƒŒæ™¯è®¾ç½®é…ç½®
    let bgConfig = {
        type: 'none',   // none, dot, grid, image
        imageSrc: '',   // ä¸Šä¼ å›¾ç‰‡çš„base64
        bubbleOp: 1,    // æ°”æ³¡é€æ˜åº¦ 0-1
        bgOpacity: 0.3, // ğŸŸ¢ é»˜è®¤30%
    };

    function initVisualViewport() {
        if (window.visualViewport) {
            const app = document.getElementById('app-container');
            const handleResize = () => {
                app.style.height = window.visualViewport.height + 'px';
                window.scrollTo(0, 0);
                const isKeyboardUp = window.visualViewport.height < window.innerHeight * 0.85;
                document.body.classList.toggle('keyboard-active', isKeyboardUp && document.activeElement?.id !== 'header-note');
            };
            window.visualViewport.addEventListener('resize', handleResize);
            window.visualViewport.addEventListener('scroll', () => window.scrollTo(0, 0));
            document.getElementById('mode-note').addEventListener('focus', handleResize);
            handleResize();
        }
    }

    function toggleCustomMenu(e) {
        if(e) e.stopPropagation();
        const menu = document.getElementById('custom-dropdown');
        const btn = document.querySelector('.custom-btn');
        menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
        if(menu.style.display === 'flex') btn.classList.add('active'); else btn.classList.remove('active');
    }
    
    function toggleBgMenu(e) {
        if(e) e.stopPropagation();
        const menu = document.getElementById('bg-dropdown');
        const btn = document.getElementById('bg-btn');
        document.getElementById('font-dropdown').style.display = 'none';
        document.getElementById('custom-dropdown').style.display = 'none';
        menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
        if(menu.style.display === 'flex') btn.classList.add('active'); else btn.classList.remove('active');
    }
    
    // ğŸŸ¢ æ–°å¢ï¼šç™½è‰²æ–‡å­—æ¨¡å¼åˆ‡æ¢
    function toggleWhiteTextMode(checked) {
        if(checked) {
            document.body.classList.add('white-text-mode');
        } else {
            document.body.classList.remove('white-text-mode');
        }
        localStorage.setItem('mochi_white_text_on', checked);
        
        // åˆ·æ–° Logo é¢œè‰²
        refreshLogo(); 
        
        // åˆ·æ–°æ ‡é¢˜é¢œè‰²
        applyTitleStyles();
    }

// ğŸŸ¢ ä¿®å¤ï¼šèƒŒæ™¯åˆ‡æ¢ (ä¿®å¤åœ†ç‚¹å·¨å¤§åŒ–Bug + æä¾›å°ºå¯¸/é€æ˜åº¦ä¿®æ”¹ä½)
    function setBgPattern(type) {
        bgConfig.type = type;
        const layer = document.getElementById('bg-layer');
        const slider = document.getElementById('bg-op-slider');
        
        layer.style.transition = 'none'; 
        layer.style.backgroundImage = '';

        // ğŸŸ¢ å¹³ç§»æ§åˆ¶
        const moveX = 'center'; 
        const moveY = '-2px';
        layer.style.backgroundPosition = `${moveX} ${moveY}`;

        if (type === 'none') {
            layer.style.opacity = 0;
            if(slider) { slider.disabled = false; slider.style.opacity = '1'; }
            
        } else if (type === 'dot') {
            // [åœ†ç‚¹è®¾ç½®åŒºåŸŸ]
            const size = 20; 
            
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = currentThemeHex;
            ctx.beginPath();
            ctx.arc(size/2, size/2, 2.5, 0, Math.PI * 2);
            ctx.fill();
            
            const pngUrl = canvas.toDataURL('image/png');
            
            bgConfig.bgOpacity = 0.2;
            layer.style.opacity = 0.2;
            
            layer.style.backgroundImage = `url(${pngUrl})`;
            
            // ğŸ”´ å…³é”®ä¿®å¤ï¼šå¿…é¡»æ˜¾å¼é‡ç½®å¤§å°ï¼Œå¦åˆ™ä¼šç»§æ‰¿å›¾ç‰‡çš„100%å¯¼è‡´å·¨å¤§åŒ–
            layer.style.backgroundSize = `${size}px ${size}px`; 
            layer.style.backgroundRepeat = 'repeat';
            
            if(slider) { slider.value = 30; slider.disabled = true; slider.style.opacity = '0.5'; }

        } else if (type === 'grid') {
            // [æ–¹æ ¼è®¾ç½®åŒºåŸŸ]
            bgConfig.bgOpacity = 0.2;
            layer.style.opacity = 0.2;
            
            const gridSize = '20px';
            layer.style.backgroundSize = `${gridSize} ${gridSize}`;
            
            layer.style.backgroundImage = `linear-gradient(${currentThemeHex} 1px, transparent 1px), linear-gradient(90deg, ${currentThemeHex} 1px, transparent 1px)`;
            layer.style.backgroundRepeat = 'repeat';
            
            if(slider) { slider.value = 30; slider.disabled = true; slider.style.opacity = '0.5'; }

        } else if (type === 'image' && bgConfig.imageSrc) {
            layer.style.backgroundImage = `url(${bgConfig.imageSrc})`;
            layer.style.backgroundSize = '100% auto';
            layer.style.backgroundRepeat = 'repeat-y'; 
            
            if(slider) { 
                slider.disabled = false; 
                slider.style.opacity = '1';
                layer.style.opacity = bgConfig.bgOpacity; 
                slider.value = bgConfig.bgOpacity * 100;
            }
        }
        
        localStorage.setItem('mochi_bg_config', JSON.stringify(bgConfig));
    }

    function triggerBgUpload() {
        document.getElementById('bg-img-input').click();
    }
    
    function handleBgUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const src = e.target.result;
                bgConfig.type = 'image';
                bgConfig.imageSrc = src;
                // ä¸Šä¼ å›¾ç‰‡åï¼Œè°ƒç”¨ä¸€ä¸‹è®¾ç½®å‡½æ•°æ¥åˆ·æ–°
                setBgPattern('image');
            }
            reader.readAsDataURL(input.files[0]);
        }
        input.value = '';
    }

    // ğŸŸ¢ æ–°å¢ï¼šæ»‘è½¨æ§åˆ¶é€»è¾‘
    function setBubbleOpacity(val) {
        bgConfig.bubbleOp = val / 100;
        document.documentElement.style.setProperty('--bubble-op', bgConfig.bubbleOp);
        localStorage.setItem('mochi_bg_config', JSON.stringify(bgConfig));
    }

    // ğŸŸ¢ ä¿®å¤ï¼šèƒŒæ™¯é€æ˜åº¦æ§åˆ¶ (ä»…å¯¹å›¾ç‰‡ç”Ÿæ•ˆ)
    function setBackgroundOpacity(val) {
        // å¦‚æœæ˜¯çŸ¢é‡èƒŒæ™¯ï¼Œç›´æ¥å¿½ç•¥æ»‘è½¨æ“ä½œ
        if(bgConfig.type === 'dot' || bgConfig.type === 'grid') return;
        
        bgConfig.bgOpacity = val / 100;
        const layer = document.getElementById('bg-layer');
        if(layer) layer.style.opacity = bgConfig.bgOpacity;
        localStorage.setItem('mochi_bg_config', JSON.stringify(bgConfig));
    }
    
    // åŠ è½½èƒŒæ™¯è®¾ç½®
    function loadBgSettings() {
        const saved = localStorage.getItem('mochi_bg_config');
        if (saved) {
            const parsed = JSON.parse(saved);
            bgConfig = { ...bgConfig, ...parsed };
            
            // æ¢å¤ Pattern / Image
            if (bgConfig.type === 'image' && bgConfig.imageSrc) {
                const layer = document.getElementById('bg-layer');
                layer.style.backgroundImage = `url(${bgConfig.imageSrc})`;
                layer.style.backgroundSize = '100% auto';
                layer.style.backgroundRepeat = 'repeat-y';
            } else {
                setBgPattern(bgConfig.type); 
            }
            
            // æ¢å¤é€æ˜åº¦ (å¦‚æœæœ‰ä¿å­˜å€¼ï¼Œåˆ™è¦†ç›–é»˜è®¤)
            if(bgConfig.bgOpacity === undefined) bgConfig.bgOpacity = 0.3;
            document.getElementById('bg-layer').style.opacity = bgConfig.bgOpacity;
            
            // æ¢å¤æ°”æ³¡
            document.documentElement.style.setProperty('--bubble-op', bgConfig.bubbleOp);
            
            // UI å›æ˜¾
            const bgOpSlider = document.getElementById('bg-op-slider');
            if(bgOpSlider) bgOpSlider.value = bgConfig.bgOpacity * 100;
            
            const bubbleOpSlider = document.getElementById('bubble-op-slider');
            if(bubbleOpSlider) bubbleOpSlider.value = bgConfig.bubbleOp * 100;
        }
    }

    // å±…ä¸­
    function toggleCenter() {
        if (document.queryCommandState('justifyCenter')) {
            document.execCommand('justifyLeft', false, null);
        } else {
            document.execCommand('justifyCenter', false, null);
        }
    }
    
    // å¤§å­—
    function toggleBig() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        
        let node = sel.anchorNode;
        if (node.nodeType === 3) node = node.parentNode;
        
        let targetNode = null;
        let curr = node;
        for(let i=0; i<3; i++) {
            if(!curr || curr.id==='mode-note' || curr.classList?.contains('bubble')) break;
            if(curr.classList && curr.classList.contains('text-big')) {
                targetNode = curr;
                break;
            }
            curr = curr.parentNode;
        }

        if (targetNode) {
            targetNode.classList.remove('text-big');
        } else {
            setMarker('text-big');
        }
    }
    
    // çŠ¶æ€è®°å¿†
    function toggleLogo(checked) {
        const wrap = document.getElementById('header-img-wrap');
        const box = document.getElementById('header-img-preview');
        
        isImgBoxOpen = checked;
        localStorage.setItem('mochi_logo_on', checked); 
        
        if(checked) {
             wrap.style.display = 'block';
             box.style.display = 'block';
             const btnImgToggle = document.getElementById('btn-img-toggle');
             if(btnImgToggle) btnImgToggle.style.display = 'none';
        } else {
             wrap.style.display = 'none';
        }
        updateHeaderPreview();
    }
    
function toggleTitle(checked) {
        const con = document.getElementById('title-container');
        const bar = document.getElementById('title-toolbar');
        localStorage.setItem('mochi_title_on', checked);
        
        if(checked) {
            con.style.display = 'block';
        } else {
            con.style.display = 'none';
            bar.style.display = 'none'; 
        }
    }
    
    function toggleMarkdown(checked) {
        isMagicOn = checked;
        localStorage.setItem('mochi_magic_on', checked);
    }

    // æ™ºèƒ½åŠ ç²—
    function toggleBold() {
        if (document.queryCommandState('bold')) {
            const sel = window.getSelection();
            if (sel && sel.isCollapsed) {
                let node = sel.anchorNode;
                if(node.nodeType === 3) node = node.parentNode; 
                
                let curr = node;
                let found = null;
                for(let i=0; i<4; i++){
                    if(!curr || curr.id==='mode-note' || curr.classList?.contains('bubble')) break;
                    const isBoldTag = (curr.tagName === 'B' || curr.tagName === 'STRONG');
                    const isBoldStyle = (curr.style.fontWeight === 'bold' || parseInt(curr.style.fontWeight) >= 700);
                    if(isBoldTag || isBoldStyle) {
                        found = curr;
                        break;
                    }
                    curr = curr.parentNode;
                }
                
                if(found) {
                    const parent = found.parentNode;
                    while(found.firstChild) {
                        parent.insertBefore(found.firstChild, found);
                    }
                    parent.removeChild(found);
                    return; 
                }
            }
        }
        document.execCommand('bold', false, null);
    }

    // æ™ºèƒ½æ–œä½“
    function toggleItalic() {
        if (document.queryCommandState('italic')) {
            const sel = window.getSelection();
            if (sel && sel.isCollapsed) {
                let node = sel.anchorNode;
                if(node.nodeType === 3) node = node.parentNode;
                
                let curr = node;
                let found = null;
                for(let i=0; i<4; i++){
                    if(!curr || curr.id==='mode-note' || curr.classList?.contains('bubble')) break;
                    const isItalicTag = (curr.tagName === 'I' || curr.tagName === 'EM');
                    const isItalicStyle = (curr.style.fontStyle === 'italic');
                    if(isItalicTag || isItalicStyle) {
                        found = curr;
                        break;
                    }
                    curr = curr.parentNode;
                }
                
                if(found) {
                    const parent = found.parentNode;
                    while(found.firstChild) {
                        parent.insertBefore(found.firstChild, found);
                    }
                    parent.removeChild(found);
                    return;
                }
            }
        }
        document.execCommand('italic', false, null);
    }

    // --- åŸç”Ÿ SVG æ•°æ® ---
    const LOGOS = {
        gpt: {
            viewBox: "0 0 1024 1024",
            path: "M552.77 960c-58.84-1.12-114.3-24.21-159.26-70.86-4.22-4.38-8.05-3.69-12.76-2.93-113.3 18.34-219.67-43.88-257.22-150.97-15.68-44.72-16.31-90.08-2.45-135.46 1.46-4.79 0.85-8-2.52-11.92-110.11-128.08-45.23-325.85 120-365.79 5.58-1.35 8.24-3.8 10.18-9.12 33.89-92.71 125.98-153.32 225.68-148.71 61.34 2.84 113.42 26.1 155.99 69.81 3.7 3.8 7.18 4.39 11.99 3.59 109.43-18.18 212.22 38.06 253.83 139.27 19.6 47.69 21.6 96.53 7.04 145.92-1.66 5.63-1.03 9.39 2.9 14 109.09 127.73 44.07 324.86-120.37 364.91-5.93 1.45-8.66 4.11-10.68 9.61C742.2 900.66 654.86 960.63 552.77 960z m177.1-317.31h0.04c0-33.52-0.18-67.04 0.16-100.56 0.06-6.12-2.1-9.28-7.29-12.15-20.62-11.38-41-23.18-61.47-34.82-9.2-5.23-9.22-5.22-9.22 5.01-0.03 74.74-0.36 149.48 0.14 224.22 0.11 16.9-6.2 27.77-21.06 36.06-57.97 32.35-115.53 65.43-173.25 98.23-7.05 4.01-7.11 4.09-0.32 9.04 29.15 21.28 61.79 32.41 98.11 33.51 94.25 2.85 173.38-72.13 174.12-165.43 0.25-31.04 0.04-62.07 0.04-93.11zM562.89 380.9c4.12 2.44 6.87 4.14 9.67 5.74 65.31 37.23 130.48 74.69 196.04 111.48 14.6 8.2 20.95 18.87 20.83 35.46-0.5 65.32-0.21 130.64-0.2 195.97 0 10.09 0.06 10.17 9.06 6.22 37.72-16.54 66.15-42.66 84.36-79.48 14.26-28.83 20.59-59.17 16.95-91.04-6.77-59.33-37.54-102.98-89.92-132.4-52-29.21-103.95-58.51-155.41-88.62-10.29-6.02-17.54-6.29-27.56-0.02-20.32 12.72-41.56 24.01-63.82 36.69z m10.55-219.72c-42.3-32.68-88.9-45.43-140.36-35.84-82.31 15.34-138.09 82.91-138.71 166.77-0.47 63.57-0.05 127.15-0.2 190.73-0.01 5.07 1.51 8.06 6.11 10.61 21.26 11.78 42.3 23.95 63.42 35.96 8.41 4.78 8.44 4.77 8.44-4.79 0.01-76.24 0.08-152.48-0.06-228.72-0.03-13.76 5.55-23.56 17.76-30.4 33.67-18.86 67.12-38.08 100.66-57.15 27.2-15.46 54.39-30.93 82.94-47.17zM423.16 403.1c3.83-2.12 6.66-3.66 9.46-5.25 64.65-36.83 129.51-73.32 193.79-110.76 16.62-9.68 30.57-9.21 46.95 0.36 56.65 33.13 113.93 65.21 170.82 97.94 5.82 3.35 7.02 1.65 7.6-3.82 1.91-17.89 1.68-35.7-2.07-53.36-24.13-113.69-148.73-170.17-251.3-113.36-57.2 31.68-113.64 64.72-170.52 96.96-4.15 2.35-5.36 5.08-5.34 9.51 0.16 25.08 0.07 50.16 0.09 75.24 0 1.7 0.26 3.4 0.52 6.54z m37.99 239.22c-3.22-1.95-5.1-3.15-7.04-4.25-66.2-37.68-132.3-75.53-198.69-112.88-14.2-7.99-20.8-18.6-20.69-34.88 0.42-65.57 0.18-131.14 0.17-196.7 0-9.49-0.15-9.75-8.75-5.77-62.65 29.01-98.34 77.66-101.97 145.77-3.45 64.64 24.05 116.47 79.95 150.53 57.3 34.92 116.43 66.9 174.75 100.19 2.47 1.41 4.61 2.41 7.61 0.68 24.49-14.13 49.08-28.1 74.66-42.69z m140.28 23.44V630c0-9.54-0.03-9.58-8.29-4.88-65.73 37.48-131.58 74.76-197.08 112.61-14.62 8.45-27.56 8.77-42.28 0.24-57.65-33.42-115.7-66.17-173.52-99.31-5.03-2.88-6.87-3.23-7.69 3.53-5.01 41.13 3.75 79.21 26.74 113.61 49.29 73.73 146.58 96.84 225.82 53.21 57.51-31.66 114.2-64.77 171.33-97.1 3.82-2.16 5.13-4.69 5.05-8.9-0.24-12.41-0.08-24.83-0.08-37.25z m-0.21-154.58c0-14.65-0.15-29.31 0.09-43.95 0.07-4.49-1.3-7.21-5.38-9.51-26.42-14.86-52.75-29.9-78.97-45.11-3.82-2.22-6.67-1.99-10.33 0.12-26.04 15.03-52.12 29.99-78.34 44.71-4.3 2.41-5.88 5.17-5.85 10 0.2 29.3 0.2 58.61 0 87.91-0.04 5.06 1.51 8.02 6.12 10.59 26.25 14.67 52.34 29.61 78.34 44.7 3.82 2.21 6.55 1.96 10.19-0.15 26.25-15.16 52.57-30.21 79.01-45.05 4.15-2.33 5.27-5.15 5.21-9.57-0.23-14.89-0.09-29.79-0.09-44.69z",
            color: "#000000"
        },
        gemini: {
            viewBox: "0 0 1024 1024",
            path: "M960 512.896A477.248 477.248 0 0 0 512.896 960h-1.792A477.184 477.184 0 0 0 64 512.896v-1.792A477.184 477.184 0 0 0 511.104 64h1.792A477.248 477.248 0 0 0 960 511.104z",
            color: "#448AFF"
        },
        claude: {
            viewBox: "0 0 1024 1024",
            path: "M198.4 678.4l198.4-115.2 6.4-12.8H243.2l-96-6.4-102.4-6.4-19.2-6.4-25.6-25.6v-12.8l19.2-12.8h32l64 6.4 96 6.4 70.4 6.4L384 512h19.2V492.8l-6.4-6.4-102.4-64-108.8-76.8-51.2-38.4-32-19.2-19.2-25.6-6.4-38.4 32-32h44.8l38.4 32 83.2 64L384 364.8l12.8 12.8 6.4-6.4-6.4-12.8L339.2 256l-64-108.8-25.6-38.4-6.4-25.6c0-12.8-6.4-19.2-6.4-32l32-44.8 19.2-6.4 44.8 6.4 19.2 12.8 25.6 57.6 44.8 96 64 128 19.2 38.4 6.4 38.4 6.4 12.8h6.4V384l6.4-70.4 12.8-89.6 12.8-115.2 6.4-32 19.2-38.4 32-19.2 25.6 12.8 19.2 32v19.2l-32 70.4-19.2 121.6-19.2 83.2h6.4l12.8-12.8 44.8-57.6 70.4-89.6 32-32 38.4-38.4 25.6-19.2h44.8l32 51.2-12.8 51.2-51.2 57.6-38.4 51.2-51.2 70.4-38.4 57.6v6.4h6.4l121.6-25.6 64-12.8 76.8-12.8 38.4 19.2 6.4 19.2-12.8 32-83.2 19.2-96 19.2-147.2 32 64 6.4h96l128 6.4 32 19.2 25.6 38.4-6.4 19.2-51.2 25.6-70.4-12.8-160-38.4-57.6-12.8h-6.4v6.4l44.8 44.8 83.2 76.8 108.8 102.4 6.4 25.6-12.8 19.2h-12.8l-96-70.4-38.4-32-83.2-70.4h-6.4v6.4l19.2 25.6 102.4 147.2 6.4 44.8-6.4 12.8-25.6 6.4-25.6-6.4-57.6-83.2-64-83.2-51.2-83.2-6.4 6.4-25.6 307.2-12.8 12.8-32 12.8-25.6-19.2-12.8-32 12.8-64 19.2-83.2 12.8-64 12.8-83.2 6.4-25.6h-6.4l-64 83.2-96 128-70.4 76.8-19.2 6.4-32-12.8v-25.6l19.2-25.6 102.4-128 64-83.2 38.4-51.2v-6.4l-268.8 172.8-51.2 12.8-19.2-19.2v-32l12.8-12.8 76.8-57.6z m0 0",
            color: "#D97757"
        }
    };
    
    const fonts = [
        { name: 'æ€æºé»‘ä½“', val: '"PingFang SC", "Noto Sans SC", sans-serif' },
        { name: 'æ€æºå®‹ä½“', val: '"Songti SC", "Noto Serif SC", serif' },
        
        { name: 'æ±ŸåŸå¾‹åŠ¨å®‹', val: "'JiangCheng', serif" },
        { name: 'ç›¼éœ“æ˜æœ', val: "'PanNi', serif" },
        { name: 'å±±æµ·è‹±ä¼¦å“¥ç‰¹', val: "'ShanHai', cursive" },
        { name: 'è‰ºæœ¯ä½“ 5bil', val: "'5bil91', cursive" },
        
        { name: 'Alpha Clouds', val: "'AlphaClouds', cursive" },
        { name: 'Alt Gotisch', val: "'AltGotisch', cursive" },
        { name: 'Koenigsberger', val: "'Koenigsberger', cursive" },
        { name: 'Lettre Etoile', val: "'LettreEtoile', cursive" },
        { name: 'Medicall', val: "'Medicall', cursive" },
        { name: 'Molyna', val: "'Molyna', cursive" },
        { name: 'Plum Script', val: "'PlumScript', cursive" },
        { name: 'Star Hand', val: "'StarHand', cursive" },
        
        { name: 'Pinyon Script', val: "'Pinyon Script', cursive" },
        { name: 'Great Vibes', val: "'Great Vibes', cursive" },
        { name: 'Parisienne', val: "'Parisienne', cursive" },
        { name: 'Allura', val: "'Allura', cursive" },
        { name: 'Petit Formal', val: "'Petit Formal Script', cursive" },
        { name: 'Monsieur La', val: "'Monsieur La Doulaise', cursive" },
        { name: 'Qwigley', val: "'Qwigley', cursive" },
        { name: 'Sacramento', val: "'Sacramento', cursive" },
        { name: 'Ephesis', val: "'Ephesis', cursive" },
        { name: 'Unifraktur', val: "'UnifrakturMaguntia', cursive" },
        { name: 'Tangerine', val: "'Tangerine', cursive" },
        { name: 'Pacifico', val: "'Pacifico', cursive" },
        { name: 'Dancing Script', val: "'Dancing Script', cursive" },
    ];
    let currentFont = fonts[0].val;
    let bodyFontVal = 16;
    let headerFontVal = 18;
    
    let isImgBoxOpen = false;

    // ğŸŸ¢ Window.onloadï¼šåˆå§‹åŒ–
    window.onload = function() {
        initVisualViewport();

        const puzzlePaths = `
        <g>
            <path fill="currentColor" style="opacity:0.3; mix-blend-mode: multiply;" d="M12132 15586c265,363 405,899 939,1612 296,397 627,443 671,574 -960,313 -1865,-1741 -2218,-2076 -221,-211 -304,-133 -302,-299 292,-247 747,-32 910,189zm-6115 -1370c32,42 4,-10 36,65 4,8 22,64 22,72 90,355 46,140 110,319 239,667 904,1444 1410,1901 140,125 230,207 363,314 235,190 311,162 301,327 -80,32 -594,90 -682,80 -215,-24 -410,-122 -530,-259 -551,-632 -898,-1128 -1261,-1909 -101,-219 -115,-370 -189,-605 -48,-152 -62,-200 98,-244 93,-27 233,-63 322,-61zm-1759 -3158c-269,-174 -755,-791 -928,-1162 -176,-374 -335,-675 -471,-1078 -91,-275 -93,-289 -199,-324 -155,318 363,1155 500,1404l747 1247c-29,40 -308,309 -526,174 -269,-170 -251,-144 -430,-389 -386,-528 -1026,-1713 -813,-2385 48,-149 235,-328 397,-412 185,-94 344,-199 532,-287l797 -432c97,-58 171,-92 267,-150 322,-191 615,-452 940,-703 265,-203 634,-520 777,-861 183,-430 0,-661 -167,-906 -90,-132 -86,-168 -241,-204 28,295 388,508 249,927 -62,191 -277,618 -512,629 -32,-173 -6,-356 -40,-543 -24,-142 -80,-307 -138,-423 -199,-396 -330,-500 -430,-679 -379,-688 -225,-1622 157,-1628 4,335 28,661 174,912 69,122 314,572 466,580 -16,-101 -307,-528 -367,-647 -133,-259 -195,-490 -73,-767 41,-98 113,-253 167,-359 159,-315 793,-375 1130,-369 1446,28 1428,1339 2221,1802 233,137 608,125 847,43 337,-113 375,-175 592,-406 318,-337 669,-632 1048,-946 155,-128 422,-397 707,-305 78,24 532,334 604,398 797,735 773,745 1428,1590 148,191 273,367 405,596 446,775 -140,781 -700,1010 -908,375 -1613,1883 -982,2606 259,297 869,616 1437,486 478,-107 960,-440 1285,-703 500,-409 480,-823 1233,-279 518,375 606,586 903,1094 247,424 789,1315 577,1899 -63,171 -139,147 -295,209 -191,75 -529,207 -753,223 -554,42 -1127,309 -1414,625 -403,445 -393,951 -195,1489 392,1060 727,1120 1000,2028 129,428 32,586 -22,863 -94,480 -602,884 -1016,1010 -1335,400 -1841,-275 -2427,-1337 -56,-102 -84,-223 -152,-349 -249,-464 -308,-559 -814,-691 -367,-94 -554,52 -795,185l-1266 737c-141,102 -1063,881 -1143,887 -233,16 -1375,-1265 -1540,-1454 -275,-315 -586,-863 -765,-1262 -106,-233 137,-454 324,-595 319,-241 566,-265 594,-391 -173,-109 -713,289 -809,381 -93,85 -243,313 -281,333 -65,31 -436,111 -508,107 20,-327 729,-789 1012,-978 536,-363 712,-452 1003,-988 274,-502 99,-1152 -289,-1403 -112,-72 -208,-116 -309,-193 -229,-178 -1122,-96 -1190,-102 -8,0 -18,-2 -24,-4 -8,0 -18,-4 -23,-6l-46 -20c51,-85 14,-48 113,-103 395,-220 720,-216 1162,-114 594,135 1213,434 1303,1066 52,361 95,291 -14,653 -54,176 -156,373 -257,534 -88,140 -283,283 -311,495 705,-132 1548,-2140 -201,-2800 -215,-79 -658,-253 -907,-259 -605,-16 -1129,393 -1586,757 -169,136 -480,403 -729,417zm-456 -7894c50,376 -217,1052 189,1648 241,354 560,777 556,1319 -92,298 -2337,1376 -2504,1536 -166,157 -391,304 -473,562 -57,187 -83,679 -79,922 8,510 297,1132 502,1502 207,379 560,859 845,1120 201,183 462,191 804,199 413,8 489,-273 702,-303 237,-35 398,12 731,-296 303,-283 400,-329 707,-313 359,20 572,-94 879,79 510,291 478,459 165,937 -245,374 -1514,920 -1855,1630 -55,115 -53,824 -25,980 99,608 653,1588 980,2006 143,186 779,967 958,1064 375,205 1492,197 1718,-8 149,-135 197,-119 316,-217 253,-211 562,-508 809,-685 186,-132 351,-243 610,-391 265,-151 468,-337 693,-353 325,471 993,1537 1353,1843 401,339 510,419 1142,443 777,28 327,-106 701,-102 138,0 271,26 413,18 135,-8 245,-32 380,-40 492,-28 1104,-476 1417,-864 267,-333 235,-311 360,-787 84,-317 70,-692 22,-1017 -81,-563 -514,-1129 -749,-1544 -263,-464 -641,-1247 -46,-1584 809,-460 971,-195 1762,-526 233,-97 528,-271 627,-512 94,-229 124,-737 74,-1034 -106,-625 -909,-2132 -1443,-2568 -61,-50 -259,-199 -281,-249 -143,-58 -217,-137 -376,-211 -195,-90 -193,-92 -446,-112 -650,-50 -592,-18 -1110,532 -156,166 -791,584 -1062,638 -297,125 -478,0 -729,-136 -283,-151 -303,-452 -176,-743 570,-1311 1048,-783 1722,-1412 285,-267 259,-260 285,-768 16,-334 -128,-561 -267,-785 -62,-99 -148,-209 -223,-306l-162 -220c-46,-71 -12,-6 -50,-93 -133,-106 -386,-460 -486,-604 -107,-157 -930,-972 -1094,-1104 -627,-510 -643,-454 -1175,-470 -247,-8 -277,-2 -454,106 -542,326 -1505,1372 -1782,1506 -693,339 -613,-544 -1713,-1470 -428,-361 -2012,-503 -2666,49 -30,24 -281,257 -293,263 -105,52 -101,-6 -211,88 -44,36 -76,76 -135,126 -160,135 -393,398 -357,711z"/>
            <path fill="currentColor" d="M5366 4365c-152,-8 -397,-458 -466,-580 -146,-251 -170,-577 -174,-912 -382,6 -536,940 -157,1628 100,179 231,283 430,679 58,116 114,281 138,423 34,187 8,370 40,543 235,-11 450,-438 512,-629 139,-419 -221,-632 -249,-927 155,36 151,72 241,204 167,245 350,476 167,906 -143,341 -512,658 -777,861 -325,251 -618,512 -940,703 -96,58 -170,92 -267,150l-797 432c-188,88 -347,193 -532,287 -162,84 -349,263 -397,412 -213,672 427,1857 813,2385 179,245 161,219 430,389 218,135 497,-134 526,-174l-747 -1247c-137,-249 -655,-1086 -500,-1404 106,35 108,49 199,324 136,403 295,704 471,1078 173,371 659,988 928,1162 249,-14 560,-281 729,-417 457,-364 981,-773 1586,-757 249,6 692,180 907,259 1749,660 906,2668 201,2800 28,-212 223,-355 311,-495 101,-161 203,-358 257,-534 109,-362 66,-292 14,-653 -90,-632 -709,-931 -1303,-1066 -442,-102 -767,-106 -1162,114 -99,55 -62,18 -113,103l46 20c5,2 15,6 23,6 6,2 16,4 24,4 68,6 961,-76 1190,102 101,77 197,121 309,193 388,251 563,901 289,1403 -291,536 -467,625 -1003,988 -283,189 -992,651 -1012,978 72,4 443,-76 508,-107 38,-20 188,-248 281,-333 96,-92 636,-490 809,-381 -28,126 -275,150 -594,391 -187,141 -430,362 -324,595 179,399 490,947 765,1262 165,189 1307,1470 1540,1454 80,-6 1002,-785 1143,-887l1266 -737c241,-133 428,-279 795,-185 506,132 565,227 814,691 68,126 96,247 152,349 586,1062 1092,1737 2427,1337 414,-126 922,-530 1016,-1010 54,-277 151,-435 22,-863 -273,-908 -608,-968 -1000,-2028 -198,-538 -208,-1044 195,-1489 287,-316 860,-583 1414,-625 224,-16 562,-148 753,-223 156,-62 232,-38 295,-209 212,-584 -330,-1475 -577,-1899 -297,-508 -385,-719 -903,-1094 -753,-544 -733,-130 -1233,279 -325,263 -807,596 -1285,703 -568,130 -1178,-189 -1437,-486 -631,-723 74,-2231 982,-2606 560,-229 1146,-235 700,-1010 -132,-229 -257,-405 -405,-596 -655,-845 -631,-855 -1428,-1590 -72,-64 -526,-374 -604,-398 -285,-92 -552,177 -707,305 -379,314 -730,609 -1048,946 -217,231 -255,293 -592,406 -239,82 -614,94 -847,-43 -793,-463 -775,-1774 -2221,-1802 -337,-6 -971,54 -1130,369 -54,106 -126,261 -167,359 -122,277 -60,508 73,767 60,119 351,546 367,647z"/>
            <path fill="currentColor" d="M8259 17214c10,-165 -66,-137 -301,-327 -133,-107 -223,-189 -363,-314 -506,-457 -1171,-1234 -1410,-1901 -64,-179 -20,36 -110,-319 0,-8 -18,-64 -22,-72 -32,-75 -4,-23 -36,-65 -89,-2 -229,34 -322,61 -160,44 -146,92 -98,244 74,235 88,386 189,605 363,781 710,1277 1261,1909 120,137 315,235 530,259 88,10 602,-48 682,-80z"/>
            <path fill="currentColor" d="M11222 15397c-2,166 81,88 302,299 353,335 1258,2389 2218,2076 -44,-131 -375,-177 -671,-574 -534,-713 -674,-1249 -939,-1612 -163,-221 -618,-436 -910,-189z"/>
        </g>
        `;
        document.getElementById('puzzle-icon').innerHTML = puzzlePaths;

        const savedPrimary = localStorage.getItem('mochi_theme_primary');
        const savedBgBody = localStorage.getItem('mochi_theme_bg_body');
        const savedBubbleR = localStorage.getItem('mochi_theme_bubble_r');
        const savedBgTop = localStorage.getItem('mochi_theme_bg_top');
        // ğŸŸ¢ æ–°å¢ï¼šè¯»å–æ°”æ³¡RGB
        const savedBubbleRGB = localStorage.getItem('mochi_theme_bubble_rgb');

        if(savedPrimary && savedBgBody && savedBubbleR && savedBgTop) {
            // å…¼å®¹æ—§æ•°æ®
            const rgb = savedBubbleRGB || '251,227,225';
            theme(savedPrimary, savedBgBody, savedBubbleR, savedBgTop, rgb);
        }

        const savedNote = localStorage.getItem('mochi_note_text');
        
        const savedDateOn = localStorage.getItem('mochi_date_on');
        const savedCountOn = localStorage.getItem('mochi_count_on');
        const savedLogoOn = localStorage.getItem('mochi_logo_on');
        const savedTitleOn = localStorage.getItem('mochi_title_on');
        const savedMagic = localStorage.getItem('mochi_magic_on');

        const savedFont = localStorage.getItem('mochi_font_val');
        const savedBodySize = localStorage.getItem('mochi_body_size');
        const savedHeaderSize = localStorage.getItem('mochi_header_size');
        const savedImgSrc = localStorage.getItem('mochi_header_img_src');
        const savedImgOpacity = localStorage.getItem('mochi_img_opacity');
        const savedActiveLogo = localStorage.getItem('mochi_active_logo');
        const savedColorMode = localStorage.getItem('mochi_img_color_mode');
        
        if(savedMagic !== null) {
            isMagicOn = (savedMagic === 'true');
            document.getElementById('md-switch').checked = isMagicOn;
        }

        if(savedImgSrc) {
            const finalBg = savedImgSrc.startsWith('url') ? savedImgSrc : `url(${savedImgSrc})`;
            document.getElementById('header-img-preview').style.backgroundImage = finalBg;
        }
        if(savedImgOpacity) {
            imgConfig.opacity = parseInt(savedImgOpacity);
            document.querySelector('.img-slider').value = imgConfig.opacity;
            setImgOpacity(imgConfig.opacity);
        }
        if(savedActiveLogo) imgConfig.activeLogo = savedActiveLogo;
        if(savedColorMode) imgConfig.colorMode = savedColorMode;

        // æ¢å¤ UI çŠ¶æ€
        if(savedNote) document.getElementById('header-note').value = savedNote;
        if(savedDateOn === 'true') document.getElementById('date-switch').checked = true;
        if(savedCountOn === 'false') document.getElementById('count-switch').checked = false;
        
        const logoSwitch = document.getElementById('logo-switch');
        if(savedLogoOn === 'true') {
            logoSwitch.checked = true;
            toggleLogo(true);
        } else {
            logoSwitch.checked = false;
            toggleLogo(false);
        }

        const titleSwitch = document.getElementById('title-switch');
        if(savedTitleOn === 'true') {
            titleSwitch.checked = true;
            toggleTitle(true);
        } else {
            titleSwitch.checked = false;
            toggleTitle(false);
        }

        if(savedFont) {
            currentFont = savedFont;
            document.documentElement.style.setProperty('--header-font', currentFont);
        }

        if(savedBodySize) {
            bodyFontVal = parseInt(savedBodySize);
            document.getElementById('range-body').value = bodyFontVal;
        }
        if(savedHeaderSize) {
            headerFontVal = parseInt(savedHeaderSize);
            document.getElementById('range-header').value = headerFontVal;
        }

        // ğŸŸ¢ æ–°å¢ï¼šæ¢å¤ç™½è‰²æ–‡å­—æ¨¡å¼
        const savedWhiteText = localStorage.getItem('mochi_white_text_on');
        if (savedWhiteText === 'true') {
            document.getElementById('white-text-switch').checked = true;
            toggleWhiteTextMode(true);
        }

        setBodyFont(bodyFontVal);
        setHeaderFont(headerFontVal); 

        initFontMenu();
        document.getElementById('btn-gpt').style.backgroundImage = createSvgUrl('gpt', 'original');
        document.getElementById('btn-gemini').style.backgroundImage = createSvgUrl('gemini', 'original');
        document.getElementById('btn-claude').style.backgroundImage = createSvgUrl('claude', 'original');
        
        add(DEFAULT_TXT, 'left'); 
        setTimeout(()=>{ add("", 'right'); }, 50); 
        document.getElementById('mode-note').addEventListener('paste', cleanPaste);
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
        document.addEventListener('click', function(e) {
            const btn = document.getElementById('font-btn');
            const menu = document.getElementById('font-dropdown');
            if (!btn.contains(e.target) && !menu.contains(e.target)) {
                menu.style.display = 'none';
                btn.classList.remove('active');
            }
            
            const bgMenu = document.getElementById('bg-dropdown');
            const bgBtn = document.getElementById('bg-btn');
            if(bgMenu.style.display === 'flex' && !bgMenu.contains(e.target) && !bgBtn.contains(e.target)) {
                 bgMenu.style.display = 'none';
                 bgBtn.classList.remove('active');
            }
        });
        
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('custom-dropdown');
            const btn = document.querySelector('.custom-btn');
            if (menu.style.display === 'flex' && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
                btn.classList.remove('active');
            }
        });
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('img-toolbar');
            const gear = document.getElementById('btn-img-gear');
            if(panel && panel.style.display==='flex' && !panel.contains(e.target) && !gear.contains(e.target)) {
                panel.style.display = 'none';
            }
        });
        loadTitleSettings();
        initTitleFontMenu();
        // ğŸŸ¢ åŠ è½½èƒŒæ™¯è®¾ç½®
        loadBgSettings();
        
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('title-font-menu');
            const btn = document.querySelector('.font-family-btn');
            if (menu && menu.style.display === 'block' && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
            }
        });
        const savedTitleText = localStorage.getItem('mochi_title_text');
        if(savedTitleText) document.getElementById('title-box-wrap').innerText = savedTitleText;
    };
    
    // ğŸŸ¢ ä¿®å¤ï¼šç™½è‰²æ–‡å­—æ¨¡å¼ä¸‹çš„ Logo é¢œè‰²å¤„ç†
    // (å·²ä¿®æ­£ï¼šèœå•å†…çš„å°å›¾æ ‡ä¿æŒåŸè‰²ï¼Œä¸å—ç™½è‰²æ¨¡å¼å½±å“)
    function createSvgUrl(key, overrideMode) {
        const data = LOGOS[key];
        if(!data) return '';
        
        let fillColor = data.color; 
        const mode = overrideMode || imgConfig.colorMode;
        
        // é€»è¾‘ä¿®æ”¹ï¼šåªæœ‰åœ¨â€œå¼€å¯ç™½è‰²æ¨¡å¼â€ä¸”â€œæ²¡æœ‰æŒ‡å®šç‰¹å®šé¢œè‰²æ¨¡å¼â€æ—¶ï¼Œæ‰å¼ºåˆ¶å˜ç™½
        // è¿™æ ·èœå•é‡Œçš„å›¾æ ‡ï¼ˆæŒ‡å®šäº† 'original'ï¼‰å°±ä¸ä¼šå˜ç™½çœ‹ä¸è§äº†
        if (document.body.classList.contains('white-text-mode') && !overrideMode) {
            fillColor = '#FFFFFF';
        } else {
            if (mode === 'black') fillColor = '#000000';
            else if (mode === 'theme') fillColor = currentThemeHex;
            else if (mode === 'bubble') fillColor = currentBubbleHex;
        }

        const svgString = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${data.viewBox}"><path d="${data.path}" fill="${fillColor}"/></svg>`;
        return "url('data:image/svg+xml;utf8," + encodeURIComponent(svgString) + "')";
    }

    function initFontMenu() {
        const menu = document.getElementById('font-dropdown');
        fonts.forEach(f => {
            const item = document.createElement('div');
            item.className = 'font-item';
            item.style.fontFamily = f.val;
            item.innerText = f.name;
            if(f.val === currentFont) item.classList.add('selected');
            item.onclick = () => { selectFont(f.val, item); };
            menu.appendChild(item);
        });
    }

    function toggleFontMenu() {
        const menu = document.getElementById('font-dropdown');
        const btn = document.getElementById('font-btn');
        // å…³é—­èƒŒæ™¯èœå•
        document.getElementById('bg-dropdown').style.display = 'none';
        document.getElementById('bg-btn').classList.remove('active');
        
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
            btn.classList.remove('active');
        } else {
            menu.style.display = 'block';
            btn.classList.add('active');
        }
    }

    function selectFont(fontVal, domItem) {
        currentFont = fontVal;
        document.documentElement.style.setProperty('--header-font', fontVal);
        localStorage.setItem('mochi_font_val', fontVal);
        
        document.querySelectorAll('.font-item').forEach(el => el.classList.remove('selected'));
        domItem.classList.add('selected');
        
        document.getElementById('font-dropdown').style.display = 'none';
        document.getElementById('font-btn').classList.remove('active');
    }

    function setBodyFont(v) { 
        bodyFontVal = v;
        document.getElementById('viewport').style.fontSize = v + 'px'; 
        localStorage.setItem('mochi_body_size', v);
    }

    function setHeaderFont(v) {
        headerFontVal = v;
        updateHeaderPreview(); 
        localStorage.setItem('mochi_header_size', v);
    }

    function saveCountState() {
        const isOn = document.getElementById('count-switch').checked;
        localStorage.setItem('mochi_count_on', isOn);
    }

    function updateHeaderPreview() {
        const inputVal = document.getElementById('header-note').value;
        const isDateOn = document.getElementById('date-switch').checked;
        const previewDiv = document.getElementById('paper-header');
        const pNote = document.getElementById('p-note');
        const pDate = document.getElementById('p-date');
        
        const imgWrap = document.getElementById('header-img-wrap');
        const textCol = document.querySelector('.header-text-col');
        
        localStorage.setItem('mochi_note_text', inputVal);
        localStorage.setItem('mochi_date_on', isDateOn);

        const shouldShow = inputVal || isDateOn || isImgBoxOpen;
        if(!shouldShow) {
            previewDiv.style.display = 'none';
        } else {
            previewDiv.style.display = 'flex'; 
            
            pNote.innerText = inputVal;
            pNote.style.fontSize = headerFontVal + 'px'; 

            if(isDateOn) {
                const d = new Date();
                const yy = d.getFullYear();
                const mm = (d.getMonth() + 1).toString().padStart(2, '0');
                const dd = d.getDate().toString().padStart(2, '0');
                const dateStr = `${yy}.${mm}.${dd}`;
                pDate.innerText = dateStr;
                pDate.style.display = 'block';
                pDate.style.fontSize = (headerFontVal * 0.7) + 'px';
            } else {
                pDate.style.display = 'none';
            }
            
            const imgBox = document.getElementById('header-img-preview');
            const h = textCol.offsetHeight; 
            const finalSize = (h > 0) ? h : 30;
            
            imgBox.style.width = finalSize + 'px';
            imgBox.style.height = finalSize + 'px';
        }
    }

    function triggerImgUpload() {
        document.getElementById('h-img-input').click();
    }

    function handleImgChange(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const src = e.target.result;
                const cssValue = `url(${src})`;
                
                document.getElementById('header-img-preview').style.backgroundImage = cssValue;
                localStorage.setItem('mochi_header_img_src', cssValue);
                
                imgConfig.activeLogo = null; 
                localStorage.removeItem('mochi_active_logo');
            }
            reader.readAsDataURL(input.files[0]);
        }
        input.value = '';
    }
    
    function toggleImgToolbar(e) {
        e.stopPropagation();
        const tb = document.getElementById('img-toolbar');
        if(tb.style.display === 'flex') {
            tb.style.display = 'none';
        } else {
            tb.style.display = 'flex';
        }
    }
    
    function setImgOpacity(val) {
        imgConfig.opacity = val;
        document.getElementById('header-img-preview').style.opacity = val / 100;
        localStorage.setItem('mochi_img_opacity', val);
    }
    
    function setPresetImg(type) {
        imgConfig.activeLogo = type;
        localStorage.setItem('mochi_active_logo', type);
        refreshLogo();
    }
    
    function setImgColorMode(mode) {
        imgConfig.colorMode = mode;
        localStorage.setItem('mochi_img_color_mode', mode);
        refreshLogo();
    }
    
    function refreshLogo() {
        if(imgConfig.activeLogo) {
            const url = createSvgUrl(imgConfig.activeLogo);
            document.getElementById('header-img-preview').style.backgroundImage = url;
            localStorage.setItem('mochi_header_img_src', url);
        }
    }

    function toggleTitleToolbarPanel() {
        const toolbar = document.getElementById('title-toolbar');
        if(toolbar.style.display === 'none') {
            toolbar.style.display = 'flex';
        } else {
            toolbar.style.display = 'none';
        }
    }

   function setMarker(className) {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;

        if (className === 'clear') {
            if (sel.isCollapsed) {
                let node = sel.anchorNode;
                while (node && node.nodeName !== 'DIV' && node.id !== 'viewport') {
                    const isHighlighterSpan = (node.nodeName === 'SPAN' && (
                        (node.className && node.className.startsWith('hl-')) ||
                        (node.style && node.style.backgroundColor) ||
                        (node.className && node.className.includes('text-big'))
                    ));
                    if (isHighlighterSpan) {
                        const parent = node.parentNode;
                        while (node.firstChild) {
                            parent.insertBefore(node.firstChild, node);
                        }
                        parent.removeChild(node);
                        return; 
                    }
                    node = node.parentNode;
                }
            } else {
                document.execCommand('removeFormat', false, null);
                document.execCommand('backColor', false, 'transparent');
            }
            return;
        }

        if (sel.isCollapsed) return; 

        const range = sel.getRangeAt(0);
        try {
            const span = document.createElement('span');
            span.className = className;
            range.surroundContents(span);
            sel.removeAllRanges(); 
        } catch (e) {
            const colorMap = {
                'hl-pink': 'rgba(255, 216, 228, 0.6)',
                'hl-green': 'rgba(208, 240, 192, 0.6)',
                'hl-purple': 'rgba(242, 227, 248, 0.6)',
                'hl-blue': 'rgba(204, 242, 255, 0.6)',
                'hl-yellow': 'rgba(255, 250, 205, 0.6)',
                'hl-gray': '#E8E8E8'
            };
            const color = colorMap[className];
            if(color) {
                document.execCommand('styleWithCSS', false, true);
                document.execCommand('hiliteColor', false, color);
                sel.removeAllRanges();
            }
        }
    }
    
   // ğŸŸ¢ ä¿®å¤ï¼šåˆ‡æ¢ä¸»é¢˜ (è‡ªåŠ¨åˆ¤æ–­é»‘è‰²ä¸»é¢˜æ–‡å­—é¢œè‰²)
    function theme(primary, bgBody, bubbleR, bgTop, bubbleRGB) {
        currentThemeHex = primary;
        currentBubbleHex = bubbleR;

        localStorage.setItem('mochi_theme_primary', primary);
        localStorage.setItem('mochi_theme_bg_body', bgBody);
        localStorage.setItem('mochi_theme_bubble_r', bubbleR);
        localStorage.setItem('mochi_theme_bg_top', bgTop);
        
        if(bubbleRGB) {
            localStorage.setItem('mochi_theme_bubble_rgb', bubbleRGB);
            document.documentElement.style.setProperty('--bubble-rgb', bubbleRGB);
        }

        const r = document.documentElement.style;
        r.setProperty('--primary', primary);
        r.setProperty('--bg-body', bgBody);
        r.setProperty('--bubble-R', bubbleR);
        r.setProperty('--bg-top', bgTop);
        
        // ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæ˜¯é»‘è‰²ä¸»é¢˜(#555555)ï¼Œæ–‡å­—å˜ç™½ï¼›å¦åˆ™æ·±ç°
        if (primary === '#555555') {
            r.setProperty('--text-bubble-r', '#FFFFFF');
        } else {
            r.setProperty('--text-bubble-r', '#5A5A5A');
        }
        
        if(titleConfig.colorMode === 'theme') setTitleColor('theme');
        if(titleConfig.colorMode === 'bubble') setTitleColor('bubble');
        
        if(imgConfig.activeLogo && (imgConfig.colorMode === 'theme' || imgConfig.colorMode === 'bubble')) {
            refreshLogo();
        }
        
        // å¼ºåˆ¶é‡ç»˜èƒŒæ™¯
        if (bgConfig.type === 'dot' || bgConfig.type === 'grid') {
            setBgPattern(bgConfig.type);
        }
    }

    function mode(m) {
        curMode = m;
        const n = document.getElementById('mode-note');
        const c = document.getElementById('mode-chat');
        const tn = document.getElementById('tab-note');
        const tc = document.getElementById('tab-chat');
        if(m==='note') {
            n.style.display='block'; c.style.display='none';
            tn.className='toggle-item active'; tc.className='toggle-item';
        } else {
            n.style.display='none'; c.style.display='flex';
            tn.className='toggle-item'; tc.className='toggle-item active';
        }
    }
    
    function exec(c) { document.execCommand(c, false, null);
    }
    
    function cleanPaste(e) {
        e.preventDefault();
        const t = (e.clipboardData || window.clipboardData).getData('text');
        document.execCommand('insertText', false, t);
    }

    function toTop() { document.getElementById('viewport').scrollTo({top:0, behavior:'smooth'});
    }
    function toBottom() { const v = document.getElementById('viewport'); v.scrollTo({top:v.scrollHeight, behavior:'smooth'});
    }

    function add(initialText, forceSide) {
        const s = document.getElementById('chat-stream');
        let isL;
        if(forceSide) {
            isL = (forceSide === 'left');
            turn = (isL ? 0 : 1); 
        } else {
            isL = (turn % 2 === 0);
        }

        const d = document.createElement('div');
        d.className = `bubble-wrap ${isL?'left':'right'}`;
        
        const del = document.createElement('div');
        del.className = 'del-btn'; del.innerText = 'Ã—';
        del.onclick = function(){ d.remove(); };

        const b = document.createElement('div');
        b.className = 'bubble';
        b.contentEditable = true;
        
        if(isL) {
            if(!initialText || initialText === DEFAULT_TXT) {
                b.innerText = DEFAULT_TXT;
                b.classList.add('empty-state');
            } else {
                b.innerText = initialText;
            }
            b.onfocus = function() {
                if(this.innerText === DEFAULT_TXT) {
                    this.innerText = "";
                    this.classList.remove('empty-state');
                }
            };
            b.onblur = function() {
                autoMagic(this);
                if(this.innerText.trim() === "") {
                    this.innerText = DEFAULT_TXT;
                    this.classList.add('empty-state');
                }
            };
        } else {
            b.innerText = initialText || "";
        }

        b.addEventListener('paste', cleanPaste);
        d.appendChild(del); d.appendChild(b); s.appendChild(d);
        turn++; 
        setTimeout(toBottom, 100);
    }

    // ================= æ ‡é¢˜ç‹¬ç«‹æ§åˆ¶é€»è¾‘ =================

    let titleConfig = {
        font: fonts[0].val, 
        size: 24,           
        bold: true,         
        italic: false,      
        colorMode: 'black', 
        customHue: 0,    
        customSat: 0,       
        customLight: 20     
    };

    function hexToHSL(hex) {
        hex = hex.replace(/^#/, '');
        let r = parseInt(hex.substring(0, 2), 16) / 255;
        let g = parseInt(hex.substring(2, 4), 16) / 255;
        let b = parseInt(hex.substring(4, 6), 16) / 255;

        let max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        if (max === min) {
            h = s = 0;
        } else {
            let d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
                case r: h = (g - b) / d + (g < b ? 6 : 0);
                break;
                case g: h = (b - r) / d + 2; break;
                case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
        }
        return {
            h: Math.round(h * 360),
            s: Math.round(s * 100),
            l: Math.round(l * 100)
        };
    }

    function loadTitleSettings() {
        const saved = localStorage.getItem('mochi_title_config');
        if(saved) {
            const loaded = JSON.parse(saved);
            titleConfig = { ...titleConfig, ...loaded };
            if(titleConfig.customLight === undefined) titleConfig.customLight = 60;
        }
        updateTitleUIState();
        applyTitleStyles();
    }

    function saveTitleSettings() {
        localStorage.setItem('mochi_title_config', JSON.stringify(titleConfig));
        applyTitleStyles();
        updateTitleUIState();
    }
    
    function saveTitleText() {
        const t = document.getElementById('title-box-wrap').innerText;
        localStorage.setItem('mochi_title_text', t);
    }

    function applyTitleStyles() {
        const box = document.getElementById('title-box-wrap');
        if(!box) return;

        box.style.fontFamily = titleConfig.font;
        box.style.fontSize = titleConfig.size + 'px';
        box.style.fontWeight = titleConfig.bold ? 'bold' : 'normal';
        box.style.fontStyle = titleConfig.italic ? 'italic' : 'normal';
        
        // ğŸŸ¢ ä¿®å¤ï¼šç™½è‰²æ¨¡å¼å¼ºåˆ¶æ ‡é¢˜å˜ç™½
        if (document.body.classList.contains('white-text-mode')) {
            box.style.color = '#ffffff';
            box.style.textShadow = 'none';
            return;
        }
        
        let finalHue = titleConfig.customHue;
        let finalSat = titleConfig.customSat;
        let finalLight = titleConfig.customLight;
        box.style.color = `hsl(${finalHue}, ${finalSat}%, ${finalLight}%)`;
        box.style.textShadow = 'none';
    }

    function updateTitleUIState() {
        const btnBold = document.getElementById('tt-bold');
        const btnItalic = document.getElementById('tt-italic');
        
        const sliderHue = document.getElementById('tt-hue');
        const sliderSat = document.getElementById('tt-sat');
        const sliderLight = document.getElementById('tt-light');
        const sliderSize = document.getElementById('tt-size-slider');
        if(btnBold) {
             if(titleConfig.bold) btnBold.classList.add('active'); else btnBold.classList.remove('active');
        }
        if(btnItalic) {
             if(titleConfig.italic) btnItalic.classList.add('active');
        else btnItalic.classList.remove('active');
        }
        
        if(sliderSize) sliderSize.value = titleConfig.size;
        if(sliderHue) sliderHue.value = titleConfig.customHue;
        if(sliderSat) sliderSat.value = titleConfig.customSat;
        if(sliderLight) sliderLight.value = titleConfig.customLight;
        if(sliderSat) {
            const h = titleConfig.customHue;
            const l = titleConfig.customLight;
            sliderSat.style.background = `linear-gradient(to right, hsl(${h}, 0%, ${l}%), hsl(${h}, 100%, ${l}%))`;
        }
        
        if(sliderLight) {
            const h = titleConfig.customHue;
            const s = titleConfig.customSat;
            sliderLight.style.background = `linear-gradient(to right, black, hsl(${h}, ${s}%, 50%), white)`;
        }
    }

    function setTitleSize(val) {
        titleConfig.size = val;
        saveTitleSettings();
    }

    function toggleTitleStyle(type) {
        if(type === 'bold') titleConfig.bold = !titleConfig.bold;
        if(type === 'italic') titleConfig.italic = !titleConfig.italic;
        saveTitleSettings();
    }

    function setTitleColor(mode, val) {
        titleConfig.colorMode = mode;
        if(mode === 'customHue') {
            titleConfig.colorMode = 'custom';
            titleConfig.customHue = val;
        } else if (mode === 'customSat') {
            titleConfig.colorMode = 'custom';
            titleConfig.customSat = val;
        } else if (mode === 'customLight') {
            titleConfig.colorMode = 'custom';
            titleConfig.customLight = val;
        } else if (mode === 'black') {
            titleConfig.customHue = 0;
            titleConfig.customSat = 0;
            titleConfig.customLight = 20; 
        } else if (mode === 'theme') {
            const hsl = hexToHSL(currentThemeHex);
            titleConfig.customHue = hsl.h;
            titleConfig.customSat = hsl.s;
            titleConfig.customLight = hsl.l;
        } else if (mode === 'bubble') {
            const hsl = hexToHSL(currentBubbleHex);
            titleConfig.customHue = hsl.h;
            titleConfig.customSat = hsl.s;
            titleConfig.customLight = hsl.l; 
        }
        
        saveTitleSettings();
    }

    function initTitleFontMenu() {
        const menu = document.getElementById('title-font-menu');
        menu.innerHTML = ''; 
        fonts.forEach(f => {
            const item = document.createElement('div');
            item.className = 'tt-font-item';
            item.innerText = f.name;
            item.style.fontFamily = f.val;
            item.onclick = () => {
                titleConfig.font = f.val;
                saveTitleSettings();
                menu.style.display = 'none';
            };
            menu.appendChild(item);
        });
    }

    function toggleTitleFontMenu(e) {
        e.stopPropagation();
        const menu = document.getElementById('title-font-menu');
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }

    // ================= IndexedDB æ ¸å¿ƒé€»è¾‘ =================
    let db;
    const DB_NAME = "MochiDatabase";
    const STORE_NAME = "notes";

    const request = indexedDB.open(DB_NAME, 1);
    
    request.onupgradeneeded = function(event) {
        db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: "id" });
        }
    };
    
    request.onsuccess = function(event) {
        db = event.target.result;
    };
    request.onerror = function(event) {
        console.log("DB Error: " + event.target.errorCode);
    };

    function saveCurrentNote() {
        if (!db) return;
        
        const titleBox = document.getElementById('title-box-wrap');
        const titleSwitch = document.getElementById('title-switch');
        let title = titleBox.innerText.trim();
        
        // æ ‡é¢˜å…œåº•é€»è¾‘
        const d = new Date();
        const dateStrSimple = `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
        
        if(!title || !titleSwitch.checked) {
             title = `æ— æ ‡é¢˜ (${dateStrSimple})`;
        }

        let contentHTML = "";
        let plainText = ""; 
        let modeType = curMode;
        
        if(curMode === 'note') {
            const el = document.getElementById('mode-note');
            contentHTML = el.innerHTML;
            plainText = el.innerText;
        } else {
            const el = document.getElementById('chat-stream');
            contentHTML = el.innerHTML;
            el.querySelectorAll('.bubble').forEach(b => {
                if(!b.classList.contains('empty-state')) plainText += b.innerText + " ";
            });
        }
        
        // ç”Ÿæˆ 50 å­—æ‘˜è¦
        let preview = plainText.replace(/\s+/g, ' ').trim().substring(0, 50);
        if(plainText.length > 50) preview += "...";
        if(!preview) preview = "ï¼ˆæ— æ­£æ–‡å†…å®¹ï¼‰";
        
        const noteData = {
            id: Date.now(), 
            title: title,
            mode: modeType,
            content: contentHTML,
            preview: preview, // æ–°å¢å­—æ®µ
            dateStr: new Date().toLocaleString()
        };
        const transaction = db.transaction([STORE_NAME], "readwrite");
        const store = transaction.objectStore(STORE_NAME);
        store.add(noteData);
        
        showToast("å·²æ”¶å…¥è®°å¿†åº“ âœ¨");
        loadLibraryList();
    }
    
    function loadLibraryList() {
        if(!db) return;
        const listDiv = document.getElementById('lib-list');
        listDiv.innerHTML = '';
        
        const transaction = db.transaction([STORE_NAME], "readonly");
        const store = transaction.objectStore(STORE_NAME);
        const req = store.openCursor(null, 'prev'); 
        
        req.onsuccess = function(event) {
            const cursor = event.target.result;
            if (cursor) {
                const note = cursor.value;
                const item = document.createElement('div');
                item.className = 'lib-item';
                // ç¡®ä¿ preview å­—æ®µå…¼å®¹æ—§æ•°æ®
                const previewText = note.preview || "ï¼ˆæ—§æ•°æ®æ— æ‘˜è¦ï¼‰";
                
                item.innerHTML = `
                    <div class="lib-info" onclick="loadNote(${note.id})">
                        <div class="lib-name">${note.title}</div>
                        <div class="lib-date">${note.mode === 'chat' ? 'å‰§åœº' : 'éšè®°'} Â· ${note.dateStr}</div>
                        <div class="lib-preview">${previewText}</div>
                    </div>
                    <div class="lib-del" onclick="deleteNote(${note.id})">åˆ é™¤</div>
                `;
                listDiv.appendChild(item);
                
                cursor.continue();
            }
        };
    }
    
    function loadNote(id) {
        if(!confirm("è¯»å–å­˜æ¡£ä¼šè¦†ç›–å½“å‰å±å¹•ä¸Šçš„å†…å®¹ï¼Œç¡®å®šå—ï¼Ÿ")) return;
        const transaction = db.transaction([STORE_NAME], "readonly");
        const store = transaction.objectStore(STORE_NAME);
        const req = store.get(id);
        req.onsuccess = function(event) {
            const note = event.target.result;
            if(note) {
                mode(note.mode);
                document.getElementById('title-box-wrap').innerText = note.title;
                // è¯»å–æ—¶é¡ºä¾¿æŠŠæ ‡é¢˜æ˜¾ç¤ºå‡ºæ¥ï¼Œå¦åˆ™ç”¨æˆ·ä¸çŸ¥é“
                document.getElementById('title-switch').checked = true;
                toggleTitle(true);

                if(note.mode === 'note') {
                    document.getElementById('mode-note').innerHTML = note.content;
                } else {
                    document.getElementById('chat-stream').innerHTML = note.content;
                    reattachEvents(); 
                }
                closeLibrary();
            }
        };
    }
    
    function deleteNote(id) {
        if(!confirm("ç¡®å®šè¦é”€æ¯è¿™æ¡è®°å¿†å—ï¼Ÿ")) return;
        const transaction = db.transaction([STORE_NAME], "readwrite");
        const store = transaction.objectStore(STORE_NAME);
        store.delete(id);
        transaction.oncomplete = function() {
            loadLibraryList();
        };
    }
    
    function reattachEvents() {
        document.querySelectorAll('.del-btn').forEach(btn => {
            btn.onclick = function() { this.parentNode.remove(); };
        });
        document.querySelectorAll('.bubble').forEach(b => {
             b.addEventListener('paste', cleanPaste);
             b.onblur = function() {
                autoMagic(this); 
                if(this.innerText.trim() === "") {
                    this.innerText = DEFAULT_TXT;
                    this.classList.add('empty-state');
                }
            };
        });
    }

    function openLibrary() {
        document.getElementById('lib-modal').style.display = 'flex';
        loadLibraryList();
    }
    
    function closeLibrary() {
        document.getElementById('lib-modal').style.display = 'none';
    }
    
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(()=>{ t.classList.remove('show') }, 2000);
    }

    // ================= ğŸª„ è‡ªåŠ¨é­”æ³•æ ¼å¼åŒ– =================
    function autoMagic(target) {
        if (!isMagicOn) return;
        let h = target.innerHTML;
        let original = h;

        h = h.replace(/â¸»|-{3,}/g, '<hr class="theme-hr">');
        h = h.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        h = h.replace(/\*([^*]+)\*/g, '<i>$1</i>');
        h = h.replace(/~~(.*?)~~/g, '<s>$1</s>');
        h = h.replace(/`(.*?)`/g, '<code>$1</code>');

        h = h.replace(/(?:^|<div>|<br>)\s*####\s+(.*?)(?:<br>|<\/div>|$)/g, '<div><h4>$1</h4></div>');
        h = h.replace(/(?:^|<div>|<br>)\s*###\s+(.*?)(?:<br>|<\/div>|$)/g, '<div><h3>$1</h3></div>');
        h = h.replace(/(?:^|<div>|<br>)\s*##\s+(.*?)(?:<br>|<\/div>|$)/g, '<div><h2>$1</h2></div>');
        h = h.replace(/(?:^|<div>|<br>)\s*#\s+(.*?)(?:<br>|<\/div>|$)/g, '<div><h1>$1</h1></div>');
        if(h !== original) {
            target.innerHTML = h;
        }
    }

   // ================= å¯¼å‡ºé€»è¾‘ (åŒæ­¥å¹³ç§»ç‰ˆ) =================
    function exportImg() {
        document.body.classList.add('printing');

        const rootStyle = getComputedStyle(document.documentElement);
        const p = rootStyle.getPropertyValue('--primary').trim();
        const bR = rootStyle.getPropertyValue('--bubble-R');
        const tm = rootStyle.getPropertyValue('--text-main');
        const textBubble = rootStyle.getPropertyValue('--text-bubble-r') || '#5A5A5A';
        const headerFont = rootStyle.getPropertyValue('--header-font');
        const bubbleRGB = rootStyle.getPropertyValue('--bubble-rgb');
        const bubbleOp = rootStyle.getPropertyValue('--bubble-op');

        const appWidth = document.getElementById('app-container').offsetWidth;
        
        // ğŸŸ¢ è·å–çœŸå®èƒŒæ™¯å±‚ä¿¡æ¯ (åŒ…æ‹¬å¹³ç§»ä½ç½®)
        const realBgLayer = document.getElementById('bg-layer');
        const bgOpacity = realBgLayer.style.opacity || '0.3';
        const bgImage = realBgLayer.style.backgroundImage;
        const bgSize = realBgLayer.style.backgroundSize;
        const bgRepeat = realBgLayer.style.backgroundRepeat;
        // ğŸ”´ å…³é”®æ–°å¢ï¼šè·å–å½“å‰çš„å¹³ç§»ä½ç½®
        const bgPos = realBgLayer.style.backgroundPosition || '0% 0%';

        // å…‹éš†å¤´éƒ¨
        const previewHeaderClone = document.getElementById('paper-header').cloneNode(true);
        previewHeaderClone.style.display = 'flex'; 

        // å…‹éš†æ ‡é¢˜
        const titleContainer = document.getElementById('title-container');
        let titleBoxClone = null;
        const originalTitleBox = document.getElementById('title-box-wrap');
        if (titleContainer.style.display === 'block' && originalTitleBox.innerText.trim() !== '') {
            titleBoxClone = originalTitleBox.cloneNode(true);
            titleBoxClone.style.fontFamily = getComputedStyle(originalTitleBox).fontFamily;
            titleBoxClone.style.fontSize = getComputedStyle(originalTitleBox).fontSize;
            titleBoxClone.style.color = getComputedStyle(originalTitleBox).color;
            titleBoxClone.style.fontWeight = getComputedStyle(originalTitleBox).fontWeight;
            titleBoxClone.style.fontStyle = getComputedStyle(originalTitleBox).fontStyle;
            titleBoxClone.style.border = 'none'; 
            titleBoxClone.style.textAlign = 'center';
            titleBoxClone.style.marginBottom = '15px';
        }

        // å…‹éš†å†…å®¹
        const source = curMode==='note' ? document.getElementById('mode-note') : document.getElementById('mode-chat');
        const cloneContent = source.cloneNode(true);
        
        // ğŸŸ¢ ä¿®å¤ï¼šå¯¼å‡ºæ—¶å¼ºåˆ¶åº”ç”¨å½“å‰å­—å·
        cloneContent.style.fontSize = bodyFontVal + 'px';
        
        cloneContent.querySelectorAll('.del-btn').forEach(e=>e.remove());
        const addBtn = cloneContent.querySelector('.add-btn');
        if(addBtn) addBtn.style.display='none';
        
        // ä¿®å¤å¯¼å‡ºæ°”æ³¡
        if(curMode === 'chat') {
            cloneContent.querySelectorAll('.right .bubble').forEach(b => {
                b.style.backdropFilter = 'none';
                b.style.webkitBackdropFilter = 'none';
                b.style.backgroundColor = `rgba(${bubbleRGB}, ${bubbleOp})`;
                b.style.color = textBubble;
                b.style.borderRadius = '18px 18px 2px 18px';
            });
            // ğŸŸ¢ ä¿®å¤ï¼šå‰§åœºæ¨¡å¼å¯¼å‡ºæ—¶å»é™¤åº•éƒ¨é—´è·
            cloneContent.style.paddingBottom = '0px';
        }

        if(curMode === 'note') cloneContent.style.minHeight = '0px';

        // å­—æ•°ç»Ÿè®¡
        let footerDiv = null;
        if (document.getElementById('count-switch').checked) {
            const miniFont = "font-size: 8px; font-weight: 300; font-family: -apple-system, sans-serif;";
            
            // ğŸŸ¢ ä¿®å¤ï¼šæ ¹æ®æ˜¯å¦å¼€å¯ç™½è‰²æ¨¡å¼å†³å®šå­—æ•°ç»Ÿè®¡é¢œè‰²
            const isWhiteMode = document.body.classList.contains('white-text-mode');
            const greyColor = isWhiteMode ? '#ffffff' : '#999';
            const themeColor = isWhiteMode ? '#ffffff' : p; 
            
            // è¿™é‡Œçš„ class="export-footer-text" é…åˆ CSS ä½¿ç”¨
            let footerHtml = `<span class="export-footer-text" style="color:${greyColor}; ${miniFont}">Total</span>`;
            const countText = (str) => str.replace(/\s/g, '').length;

            if (curMode === 'note') {
                // éšè®°æ¨¡å¼ï¼šåªç»Ÿè®¡æ­£æ–‡
                let noteWords = countText(source.innerText);
                if (noteWords > 0) footerHtml += `<span class="export-footer-text" style="color:${greyColor}; ${miniFont}"> Â· ${noteWords}å­—</span>`;
            } else {
                // å‰§åœºæ¨¡å¼æ¢å¤å·¦å³åˆ†åˆ«ç»Ÿè®¡
                let leftTotal = 0;
                source.querySelectorAll('.left .bubble').forEach(b => {
                    if(!b.classList.contains('empty-state')) leftTotal += countText(b.innerText);
                });

                let rightTotal = 0;
                source.querySelectorAll('.right .bubble').forEach(b => {
                    rightTotal += countText(b.innerText);
                });

                if (leftTotal > 0) footerHtml += `<span class="export-footer-text" style="color:${greyColor}; ${miniFont}"> Â· ${leftTotal}å­—</span>`;
                if (rightTotal > 0) footerHtml += `<span class="export-footer-text" style="color:${themeColor}; ${miniFont}"> Â· ${rightTotal}å­—</span>`;
            }

            footerDiv = document.createElement('div');
            footerDiv.innerHTML = footerHtml;
            footerDiv.style.cssText = `text-align: right; margin-top: 16px; width: 100%; line-height: 1.2; position:relative; z-index:10;`;
        }
        // æ„å»ºå®¹å™¨
        const box = document.createElement('div');
        box.style.position = 'fixed'; box.style.top = '-9999px'; box.style.left = '0';
        box.style.width = appWidth + 'px';
        box.style.boxSizing = 'border-box';
        box.style.padding = '25px';
        box.style.backgroundColor = '#ffffff'; 
        
        // ğŸŸ¢ ä¿®å¤ï¼šå¦‚æœæ˜¯ç™½è‰²æ¨¡å¼ï¼Œå¯¼å‡ºåº•æ¿å¯ä»¥æ˜¯é€æ˜æˆ–é»‘è‰²ï¼Œè¿™é‡Œä¿æŒé€æ˜ä»¥ä¾¿æ˜¾ç¤ºèƒŒæ™¯å±‚
        // ä½†å¦‚æœèƒŒæ™¯å±‚åŠ è½½å¤±è´¥ï¼Œé»˜è®¤ç™½è‰²åº•æ¿æ¯”è¾ƒå®‰å…¨ã€‚
        // å…³é”®åœ¨äºå†…å®¹æ–‡å­—å·²ç»æ˜¯ç™½è‰²äº†ï¼Œæ‰€ä»¥èƒŒæ™¯å±‚å¿…é¡»å­˜åœ¨ä¸”æ˜¯æ·±è‰²ã€‚
        
        box.style.display = 'flex'; box.style.flexDirection = 'column';
        
        box.style.setProperty('--primary', p);
        box.style.setProperty('--bubble-R', bR);
        box.style.setProperty('--text-main', tm);
        box.style.setProperty('--header-font', headerFont);

        // ç‹¬ç«‹èƒŒæ™¯å±‚
        const exportBgLayer = document.createElement('div');
        exportBgLayer.style.position = 'absolute';
        exportBgLayer.style.top = '0'; exportBgLayer.style.left = '0';
        exportBgLayer.style.width = '100%'; exportBgLayer.style.height = '100%';
        exportBgLayer.style.zIndex = '-1';
        
        exportBgLayer.style.backgroundImage = bgImage;
        exportBgLayer.style.backgroundSize = bgSize;
        exportBgLayer.style.backgroundRepeat = bgRepeat;
        exportBgLayer.style.opacity = bgOpacity;
        // ğŸ”´ åº”ç”¨å¹³ç§»ä½ç½®
        exportBgLayer.style.backgroundPosition = bgPos;

        box.appendChild(exportBgLayer);
        box.appendChild(previewHeaderClone);
        if(titleBoxClone) box.appendChild(titleBoxClone);
        box.appendChild(cloneContent);
        if(footerDiv) box.appendChild(footerDiv);
        
        document.body.appendChild(box);
        
        html2canvas(box, {
            scale: 3, 
            useCORS: true, 
            backgroundColor: null, 
            width: appWidth,   
            windowWidth: appWidth,
            logging: false
        }).then(canvas => {
            const imgUrl = canvas.toDataURL('image/png');
            document.getElementById('res-img').src = imgUrl;
            document.getElementById('modal').style.display = 'flex';
            document.body.removeChild(box);
            document.body.classList.remove('printing');
        }).catch(err => {
            console.error(err);
            document.body.removeChild(box);
            document.body.classList.remove('printing');
            alert("å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•");
        });
    }
</script>
</body>
</html>